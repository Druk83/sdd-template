# Трек разработки технической документации

> **Важно:** этот файл в `.requirements/**` — **методика** (read-only).
> Определяет последовательность создания документации по шаблонам.

---

## 0. Принцип работы

> **СТОП! КРИТИЧЕСКИ ВАЖНО ДЛЯ АГЕНТА:**
> 1. Выполнять ТОЛЬКО ОДИН этап за раз. После завершения этапа — ОСТАНОВИТЬСЯ и ждать команды разработчика.
> 2. **Перед этапом [1]** — сформулировать базовый контекст и получить подтверждение (см. 5.2.3).
> Подробнее: раздел 5.2 "Пошаговое выполнение".

1. Шаблоны находятся в `.requirements/**` (read-only).
2. Агент/разработчик **копирует структуру** шаблона в `docs/**` и заполняет фактами проекта.
3. **Перед этапом [1]** агент формулирует **базовый контекст** (название, определение, цель, аудитория) и запрашивает подтверждение разработчика — см. раздел 5.2.3.
4. Каждый следующий этап опирается на результаты предыдущего.
5. Если предыдущий этап не завершен — фиксировать это в `## Открытые вопросы` и добавлять GAP в `gap-tracking.md`.
6. **Перед началом этапа [1]** агент ОБЯЗАН создать файл `docs/requirements/gap-tracking.md` по шаблону из раздела 7.5.
7. **После завершения каждого этапа** агент ОБЯЗАН:
   - Проверить чеклист готовности (раздел 5)
   - Обновить `docs/requirements/gap-tracking.md` с найденными пробелами
   - **Обновить placeholder'ы** в ранее созданных документах (см. раздел 0.1)
   - **ОСТАНОВИТЬСЯ** и вывести отчёт о завершении этапа (см. раздел 5.2)
8. **Агент НЕ переходит к следующему этапу** без явной команды разработчика ("продолжай", "этап [N]").

### 0.1 Работа с placeholder'ами и отложенными ссылками

При создании документа агент часто не знает конкретных значений (например, имена доменов на этапе [1]).
В таких случаях агент ОБЯЗАН:

1. **Ставить маркер обновления** перед placeholder'ом:
   ```markdown
   <!-- @update-after:[4] Обновить когда будут определены домены -->
   * Карта процесса: `docs/requirements/сценарии/<domain_slug>/карта процесса.md`
   ```

2. **Формат маркера:**
   ```
   <!-- @update-after:[N] Описание что обновить -->
   ```
   Где `[N]` — номер этапа, после которого информация станет доступна.

3. **После завершения этапа [N]** агент ОБЯЗАН:
   - Найти все маркеры `@update-after:[N]` в `docs/requirements/**`
   - Заменить placeholder'ы на реальные значения
   - Удалить маркер после обновления

4. **Типичные placeholder'ы и когда обновлять:**

   | Placeholder | Обновлять после этапа | Пример замены |
   |-------------|----------------------|---------------|
   | `<domain_slug>` | [4] Домены | `governance`, `quality-gates` |
   | `<BC-name>` | [5] Сценарии | `PR-Management-BC` |
   | `<table_name>` | [6] Структура данных | `pull_requests`, `quality_gates` |
   | `<component>` | [7] Архитектура | `GateExecutor`, `RuleEngine` |

5. **Проверка при переходе к следующему этапу:**
   - Если в документе остались маркеры `@update-after:[текущий_этап]` — обновить их
   - Если placeholder не может быть заполнен — создать GAP в gap-tracking

---

## 1. Последовательность чтения файлов-шаблонов для агента

**Агент ДОЛЖЕН читать файлы в следующем порядке:**

| Этап | Файл шаблона | Действие |
|------|--------------|---------|
| **Подготовка** | `.requirements/трек разработки.md` | Прочитать этот файл целиком (вы его читаете) |
| **[1]** | `.requirements/предметная область.md` | Скопировать структуру в `docs/requirements/предметная область.md`, заполнить фактами |
| **[2]** | `.requirements/обоснование выбора.md` | Скопировать в `docs/requirements/обоснование выбора.md` |
| **[3а]** | `.requirements/требования/требования_гост19.md` | Выбрать подходящий (ГОСТ 19 или ГОСТ 34 или иной, который оговорен в **[1]** и **[2]**) |
| **[3б]** | `.requirements/требования/требования_гост34.md` | Скопировать выбранный в `docs/requirements/требования/` |
| **[4]** | `.requirements/домены/определение доменов.md` | Скопировать в `docs/requirements/домены/реестр.md` + создать карточки доменов |
| **[5.0]** | `.requirements/сценарии/правила.md` | Прочитать правила Event Storming |
| **[5.1]** | `.requirements/сценарии/карта процесса.md` | Скопировать в `docs/requirements/сценарии/<domain>/` для каждого домена |
| **[5.2]** | `.requirements/сценарии/каталог мероприятий.md` | Скопировать в `docs/requirements/сценарии/<domain>/` |
| **[5.3]** | `.requirements/сценарии/ограниченные контексты.md` | Скопировать в `docs/requirements/сценарии/<domain>/` |
| **[5 диаграммы]** | `.requirements/сценарии/диаграммы сценариев.md` | Построить диаграммы в `docs/requirements/сценарии/<domain>/diagrams/*.plantuml` |
| **[5 Context Map]** | `.requirements/сценарии/диаграммы Context Map.md` | Построить `docs/requirements/сценарии/<domain>/diagrams/context-map.plantuml` |
| **[6.0]** | `.requirements/структура Данных/правила проектирования данных.md` | Прочитать правила проектирования |
| **[6]** | `.requirements/структура Данных/описание БД.md` | Скопировать в `docs/requirements/структура Данных/описание БД.md` |
| **[6 шаблоны]** | `.requirements/структура Данных/шаблоны карточек.md` | Использовать для создания карточек объектов данных |
| **[7 TL]** | `.requirements/архитектура/описание TL.md` | Скопировать в `docs/requirements/архитектура/TL.md` |
| **[7 AL]** | `.requirements/архитектура/описание AL.md` | Скопировать в `docs/requirements/архитектура/AL.md` |
| **[7 BL]** | `.requirements/архитектура/описание BL.md` | Скопировать в `docs/requirements/архитектура/BL.md` |
| **[7 связи]** | `.requirements/архитектура/описание связи TL AL BL.md` | Скопировать в `docs/requirements/архитектура/связи.md` |
| **[7 сущности]** | `.requirements/архитектура/сущности архитекутры.md` | Скопировать в `docs/requirements/архитектура/сущности.md` |
| **[7 диаграммы]** | `.requirements/архитектура/диаграммы ArchiMate.md` | Построить диаграммы в `docs/requirements/архитектура/diagrams/*.plantuml` |
| **[8 стек]** | `.requirements/структура ПО/стек проекта.md` | Скопировать в `docs/requirements/структура ПО/стек проекта.md` |
| **[8 файловая]** | `.requirements/структура ПО/файловая структура проекта.md` | Скопировать в `docs/requirements/структура ПО/файловая структура.md` |
| **[8 зависимости]** | `.requirements/структура ПО/зависимости.md` | Скопировать в `docs/requirements/структура ПО/зависимости.md` |
| **[8 ports]** | `.requirements/структура ПО/ports.md` | Скопировать в `docs/requirements/структура ПО/ports.md` |
| **[9 тестирование]** | `.requirements/тестирование/стек тестов.md` | Скопировать в `docs/requirements/тестирование/стек тестов.md` |
| **[9 испытание]** | `.requirements/тестирование/испытание системы.md` | Скопировать в `docs/requirements/тестирование/испытание системы.md` |

---

## 2. Последовательность этапов

```
[1] Предметная область
         |
         v
[2] Обоснование выбора
         |
         v
[3] Требования
         |
         v
[4] Домены
         |
         v
[5] Сценарии
         |
         v
    [5.5] Диаграммы сценариев + Context Map
         |
         v
[6] Структура данных
         |
         v
[7] Архитектура
         |
         v
    [7.1] Диаграммы ArchiMate
         |
         v
[8] Структура ПО
         |
         v
[9] Тестирование
```

---

## 3. Детализация этапов

### Этап 1: Предметная область

**Цель:** понять "что строим и зачем", зафиксировать термины и границы.

| Шаблон | Результат |
|--------|-----------|
| `.requirements/предметная область.md` | `docs/requirements/предметная область.md` |

**Входы:** интервью, регламенты, законы, договоры, AS-IS описания.

**Выходы:**
- Глоссарий терминов
- Участники домена (actors)
- Доменные сущности и правила
- Use Cases (верхнеуровневые)
- Критерии успеха

**Блокирует:** все последующие этапы (это фундамент).

---

### Этап 2: Обоснование выбора

**Цель:** зафиксировать ключевые технические и методологические решения.

| Шаблон | Результат |
|--------|-----------|
| `.requirements/обоснование выбора.md` | `docs/requirements/обоснование выбора.md` |

**Входы:** предметная область, ограничения (бюджет, сроки, команда), NFR.

**Выходы:**
- Выбор стека (языки, фреймворки, БД)
- Выбор методологии (Event Storming, DDD, etc.)
- Формат диаграмм (mermaid/plantuml)
- Обоснование каждого решения
- Альтернативы и причины отказа

**Блокирует:** структура данных, архитектура, структура ПО.

---

### Этап 3: Требования

**Цель:** формализовать функциональные и нефункциональные требования.

| Шаблон | Результат |
|--------|-----------|
| `.requirements/требования/требования_гост19.md` | `docs/requirements/требования/требования_гост19.md` |
| `.requirements/требования/требования_гост34.md` | `docs/requirements/требования/требования_гост34.md` |

**Входы:** предметная область, обоснование выбора, договор/ТЗ заказчика.

**Выбор шаблона:**
- **ГОСТ 19** — для программных продуктов (библиотеки, CLI, сервисы)
- **ГОСТ 34** — для автоматизированных систем (комплексные решения с оборудованием, инфраструктурой)
- **Иной стандарт** — если проект требует другого стандарта (ISO, IEEE, внутренний регламент):
  1. Зафиксировать выбор стандарта в `docs/requirements/обоснование выбора.md`
  2. Создать шаблон `.requirements/требования/<standard>.md` по аналогии с ГОСТ 19/34
  3. Или адаптировать ближайший существующий шаблон под требуемый стандарт
  4. Результат сохранять в `docs/requirements/требования/<standard>.md` 

**Выходы:**
- Функциональные требования (FR-*)
- Нефункциональные требования (NFR-*)
- Требования к данным
- Требования к интерфейсам
- Требования к документации

**Блокирует:** сценарии, архитектура, тестирование.

---

### Этап 4: Домены

**Цель:** разбить систему на ограниченные контексты (bounded contexts).

| Шаблон | Результат |
|--------|-----------|
| `.requirements/домены/определение доменов.md` | `docs/requirements/домены/реестр.md` + `docs/requirements/домены/<slug>.md` |

**Входы:** предметная область, требования.

**Выходы:**
- Реестр доменов с описанием
- Карточка каждого домена
- Границы ответственности
- Зависимости между доменами

**Блокирует:** сценарии (создаются по доменам).

---

### Этап 5: Сценарии (Event Storming)

**Цель:** описать процессы, события и контексты для каждого домена.

| Шаблон | Результат (для каждого домена) |
|--------|--------------------------------|
| `.requirements/сценарии/карта процесса.md` | `docs/requirements/сценарии/<domain>/карта процесса.md` |
| `.requirements/сценарии/каталог мероприятий.md` | `docs/requirements/сценарии/<domain>/каталог мероприятий.md` |
| `.requirements/сценарии/ограниченные контексты.md` | `docs/requirements/сценарии/<domain>/ограниченные контексты.md` |

**Методика:** `.requirements/сценарии/правила.md`

**Входы:** домены, требования.

**Выходы (для каждого домена):**
- Карта процесса (потоки, этапы, последовательности)
- Каталог мероприятий (события, payload)
- Ограниченные контексты (границы внутри домена)
- Связь с требованиями

**Блокирует:** диаграммы сценариев (подэтап 5.5).

---

### Этап 5.5: Диаграммы сценариев + Context Map

**Цель:** визуализировать сценарии и связи между Bounded Contexts.

| Шаблон | Результат |
|--------|-----------|
| `.requirements/сценарии/диаграммы сценариев.md` | `docs/requirements/сценарии/<domain>/diagrams/UC-XX-sequence.plantuml` |
| | `docs/requirements/сценарии/<domain>/diagrams/UC-XX-activity.plantuml` |
| `.requirements/сценарии/диаграммы Context Map.md` | `docs/requirements/сценарии/<domain>/diagrams/context-map.plantuml` |

**Входы:** карта процесса, ограниченные контексты (BC), Integration Matrix.

**Выходы:**
- Sequence Diagram — взаимодействие участников во времени
- Activity Diagram — поток управления с ветвлениями
- Context Map — связи между Bounded Contexts (DDD)

**Типы связей Context Map:**
- Customer/Supplier (U/D)
- Conformist (CF)
- Anti-Corruption Layer (ACL)
- Open Host Service / Published Language (OHS/PL)
- Shared Kernel (SK)
- Partnership

**Чеклист:**
- [ ] Каждый UC имеет минимум одну диаграмму
- [ ] Context Map содержит все BC из раздела 2
- [ ] Типы связей указаны (U/D, CF, ACL, OHS)
- [ ] Диаграммы рендерятся без ошибок

**Блокирует:** структура данных (агрегаты -> сущности).

---

### Этап 6: Структура данных

**Цель:** описать модель данных и схему хранения.

| Шаблон | Результат |
|--------|-----------|
| `.requirements/структура Данных/описание БД.md` | `docs/requirements/структура Данных/описание БД.md` |

**Методики:**
- `.requirements/структура Данных/правила проектирования данных.md`
- `.requirements/структура Данных/шаблоны карточек.md`

**Входы:** обоснование выбора (тип БД), сценарии (агрегаты, события).

**Выходы:**
- Карта хранилищ
- Перечень объектов данных
- Карточки объектов (`tables/*.md`, `collections/*.md`, etc.)
- Диаграммы (ERD/Class/Component)
- Индексы, ограничения, retention

**Логика:** сценарии дают агрегаты -> агрегаты превращаются в сущности хранения.

**Блокирует:** архитектура (repositories, data access layer).

---

### Этап 7: Архитектура

**Цель:** описать архитектурные слои и их взаимодействие.

| Шаблон | Результат |
|--------|-----------|
| `.requirements/архитектура/описание TL.md` | `docs/requirements/архитектура/TL.md` |
| `.requirements/архитектура/описание AL.md` | `docs/requirements/архитектура/AL.md` |
| `.requirements/архитектура/описание BL.md` | `docs/requirements/архитектура/BL.md` |
| `.requirements/архитектура/описание связи TL AL BL.md` | `docs/requirements/архитектура/связи.md` |
| `.requirements/архитектура/сущности архитекутры.md` | `docs/requirements/архитектура/сущности.md` |

**Входы:** обоснование выбора, сценарии, структура данных.

**Выходы:**
- Technology Layer (инфраструктура, узлы, системное ПО)
- Application Layer (use cases, orchestration)
- Business Layer (domain logic, entities)
- Связи между слоями
- Архитектурные сущности

**Логика:** архитектура проектируется вокруг модели данных (repositories, use cases).

**Блокирует:** диаграммы ArchiMate (подэтап 7.1).

---

### Этап 7.1: Диаграммы ArchiMate

**Цель:** визуализировать архитектуру в формате ArchiMate диаграмм.

| Шаблон | Результат |
|--------|-----------|
| `.requirements/архитектура/диаграммы ArchiMate.md` | `docs/requirements/архитектура/diagrams/BL.plantuml` |
| | `docs/requirements/архитектура/diagrams/AL.plantuml` |
| | `docs/requirements/архитектура/diagrams/TL.plantuml` |

**Входы:** описания BL, AL, TL (готовность >= 80%), сущности архитектуры.

**Выходы:**
- BL.plantuml — Business Layer (акторы, процессы, сервисы, объекты)
- AL.plantuml — Application Layer (компоненты, интерфейсы, данные)
- TL.plantuml — Technology Layer (узлы, устройства, артефакты)

**Порядок построения:**
1. BL -> AL -> TL (снизу вверх по абстракции)
2. Сначала сущности текущего слоя
3. Затем внешние сущности из соседних слоев
4. Связи группировать по типам

**Чеклист:**
- [ ] Цвета соответствуют слоям (желтый/голубой/зеленый)
- [ ] Сущности имеют ID для трассируемости
- [ ] Легенда присутствует
- [ ] Диаграммы рендерятся без ошибок

**Блокирует:** структура ПО.

---

### Этап 8: Структура ПО

**Цель:** описать техническую организацию проекта.

| Шаблон | Результат |
|--------|-----------|
| `.requirements/структура ПО/стек проекта.md` | `docs/requirements/структура ПО/стек проекта.md` |
| `.requirements/структура ПО/файловая структура проекта.md` | `docs/requirements/структура ПО/файловая структура.md` |
| `.requirements/структура ПО/зависимости.md` | `docs/requirements/структура ПО/зависимости.md` |
| `.requirements/структура ПО/ports.md` | `docs/requirements/структура ПО/ports.md` |

**Входы:** обоснование выбора, архитектура.

**Выходы:**
- Технологический стек с версиями
- Файловая структура репозитория
- Зависимости (internal/external)
- Порты и интерфейсы

**Логика:** организация файлов/модулей под архитектуру.

**Блокирует:** реализацию.

---

### Этап 9: Тестирование

**Цель:** описать стратегию и план тестирования.

| Шаблон | Результат |
|--------|-----------|
| `.requirements/тестирование/стек тестов.md` | `docs/requirements/тестирование/стек тестов.md` |
| `.requirements/тестирование/испытание системы.md` | `docs/requirements/тестирование/испытание системы.md` |

**Входы:** требования, сценарии, архитектура.

**Выходы:**
- Стек тестирования (unit/integration/e2e)
- План испытаний
- Критерии приемки
- Матрица покрытия требований

**Блокирует:** релиз.

---

## 4. Навигация и зависимости

### 4.1 Карта связей документов

```
Шаблон                              Читает из                  Пишет в
─────────────────────────────────────────────────────────────────────────
предметная область.md         →     (входные данные)      →   глоссарий, акторы, UC
обоснование выбора.md         →     [1]                   →   стек, стандарт, методология, паттерны
требования_гост*.md           →     [1], [2]              →   FR-*, NFR-*
определение доменов.md        →     [1], [3]              →   домены, BC
карта процесса.md             →     [4]                   →   события, агрегаты
каталог мероприятий.md        →     [5.1]                 →   EVT-*, CMD-*
ограниченные контексты.md     →     [4], [5.1]            →   BC границы
описание БД.md                →     [5]                   →   таблицы, индексы
описание BL/AL/TL.md          →     [5], [6]              →   сущности слоя
описание связи TL AL BL.md    →     [7 BL/AL/TL]          →   связи между слоями
сущности архитекутры.md       →     [7]                   →   каталог сущностей
стек проекта.md               →     [2], [7]              →   технологии
файловая структура.md         →     [7], [8 стек]         →   структура папок
стек тестов.md                →     [3], [8]              →   стратегия тестов
испытание системы.md          →     [3], [9 стек]         →   план испытаний
```

### 4.2 Зависимости между этапами

```
[1] Предметная область
         |
         v
[2] Обоснование выбора
         |
         v
[3] Требования
         |
         v
[4] Домены
         |
         v
[5] Сценарии
         |
         v
    [5.1] Реестр сценариев
         |
         v
    [5.2] Карта процесса
         |
         v
    [5.3] Каталог мероприятий
         |
         v
    [5.4] Ограниченные контексты
         |
         v
    [5.5] Диаграммы сценариев + Context Map
         |
         v
[6] Структура данных
         |
         v
[7] Архитектура
         |
         v
    [7.1] Диаграммы ArchiMate
         |
         v
[8] Структура ПО
         |
         v
[9] Тестирование
```

---

## 5. Чеклист готовности этапа

**Общий чеклист (для всех этапов):**
* [ ] Шаблон скопирован в `docs/**`
* [ ] Все обязательные секции заполнены
* [ ] Ссылки на предыдущие этапы актуальны
* [ ] Открытые вопросы зафиксированы
* [ ] Задачи на доработку созданы в `.tasks/`

**Критерии готовности по этапам:**

| Этап | Минимум для перехода |
|------|---------------------|
| [1] Предметная область | Глоссарий >= 5 терминов, >= 1 актор, >= 1 Use Case |
| [2] Обоснование выбора | Выбран стек, стандарт, методология моделирования, арх. паттерн |
| [3] Требования | >= 1 FR, >= 1 NFR, приоритеты расставлены |
| [4] Домены | >= 1 домен с описанием и границами |
| [5] Сценарии | Для каждого домена: карта процесса + >= 1 событие |
| [5.5] Диаграммы сценариев + Context Map | Для каждого UC: sequence/activity + Context Map для домена |
| [6] Структура данных | >= 1 таблица/коллекция с полями |
| [7] Архитектура | BL + AL + TL описаны, >= 5 связей между слоями |
| [7.1] Диаграммы | BL + AL + TL диаграммы созданы, легенда присутствует |
| [8] Структура ПО | Стек зафиксирован, файловая структура описана |
| [9] Тестирование | Стратегия выбрана, >= 1 тест-кейс на FR |

---

## 5.2 Пошаговое выполнение (ОБЯЗАТЕЛЬНО)

> **КРИТИЧЕСКИ ВАЖНО:** Агент НЕ ДОЛЖЕН выполнять несколько этапов за один запрос.
> Каждый этап требует проверки разработчиком перед переходом к следующему.

### 5.2.1 Правило остановки

После завершения КАЖДОГО этапа агент ОБЯЗАН:

1. **ОСТАНОВИТЬСЯ** и не переходить к следующему этапу автоматически
2. **Показать результаты** текущего этапа разработчику
3. **Запросить подтверждение** для перехода к следующему этапу
4. **Дождаться явной команды** разработчика (например: "продолжай", "следующий этап", "этап [N]")

### 5.2.2 Формат завершения этапа

После выполнения этапа агент выводит:

```
---
ЭТАП [N] ЗАВЕРШЕН

Созданные артефакты:
- <путь к файлу 1>
- <путь к файлу 2>

Чеклист готовности:
- [x] <пункт 1>
- [x] <пункт 2>
- [ ] <пункт с проблемой> -> GAP-XXX

Найденные пробелы: N (см. gap-tracking.md)

ОЖИДАЮ ПОДТВЕРЖДЕНИЯ для перехода к этапу [N+1]
---
```

### 5.2.3 Базовый контекст (перед этапом [1])

Перед началом этапа [1] агент ОБЯЗАН сформулировать **базовый контекст** системы:

- Название системы / продукта
- Определение и назначение
- Ключевая проблема, которую система решает
- Целевая аудитория

**Почему это важно:**
- Базовый контекст — фундамент всей документации
- Его нельзя вывести логически или определить best practices
- Агент должен сформулировать его сам на основе `.source/`
- Разработчик должен подтвердить или скорректировать

**Алгоритм:**

1. Агент анализирует `.source/` и формулирует базовый контекст
2. Помечает в артефакте маркером `<!-- @base-context: описание -->`
3. Выводит блок "БАЗОВЫЙ КОНТЕКСТ — ТРЕБУЕТСЯ ПОДТВЕРЖДЕНИЕ"
4. Ожидает подтверждения или корректировки от разработчика
5. После подтверждения — удаляет маркер и продолжает работу
6. Если нет подтверждения — создаёт GAP с критичностью HIGH

**Формат вывода:**

```
БАЗОВЫЙ КОНТЕКСТ — ТРЕБУЕТСЯ ПОДТВЕРЖДЕНИЕ

На основе анализа .source/ агент сформулировал:

Название системы: <название>
Определение: <что это и зачем>
Ключевая проблема: <какую проблему решает>
Целевая аудитория: <для кого>

Это станет основой всей документации.
Пожалуйста, подтвердите или скорректируйте.
```

**Маркер в артефакте:**

```markdown
<!-- @base-context: название, определение — сформулировано агентом -->
## 1. Название и назначение
...
```

### 5.2.4 Правило полного завершения этапа

Агент НЕ ПЕРЕХОДИТ к следующему этапу, пока текущий не выполнен **полностью**.

**"Не определено источниками" недопустимо в финальном артефакте.**

После создания артефакта агент ОБЯЗАН:

1. **Проверить на "Не определено"** — найти все места с неполными данными
2. **Попытаться достроить самостоятельно** — используя:
   - Логику предыдущих этапов
   - Best practices отрасли
   - Здравый смысл и контекст проекта
3. **Если не может решить сам** — задать вопрос разработчику
4. **Достроить артефакт** после получения ответов
5. **Повторить проверку** пока артефакт не будет полным

**Когда агент спрашивает разработчика:**

Агент задаёт вопросы ТОЛЬКО в двух случаях:

| Тип вопроса | Когда задавать |
|-------------|----------------|
| **Выбор из вариантов** | Есть несколько равноценных решений, агент не может выбрать лучшее |
| **Разрешение коллизии** | Противоречие, разночтение или неточность в источниках |

**Формат вопросов:**

```
ТРЕБУЕТСЯ РЕШЕНИЕ РАЗРАБОТЧИКА

Выбор из вариантов:
1. <Вариант A>: <плюсы/минусы>
2. <Вариант B>: <плюсы/минусы>
Рекомендация агента: <вариант> потому что <причина>

Коллизии:
- <Описание противоречия>
  Источник 1 говорит: ...
  Источник 2 говорит: ...
  Вопрос: какой вариант верный?
```

**Агент НЕ спрашивает:**
- То, что может вывести логически из предыдущих этапов
- То, что определяется best practices
- Очевидные вещи
- Детали, которые определятся на следующих этапах

### 5.2.5 Запрещенные действия

Агент НЕ ДОЛЖЕН:
- Автоматически начинать следующий этап после завершения текущего
- Выполнять несколько этапов в одном ответе
- Предполагать, что разработчик хочет продолжить без подтверждения
- Игнорировать точки остановки
- Оставлять "Не определено источниками" в финальном артефакте
- Переходить к следующему этапу с неполным текущим
- Начинать этап [1] без подтверждения базового контекста

### 5.2.6 Точки остановки по этапам

| После этапа | Что проверяет разработчик | Команда продолжения |
|-------------|---------------------------|---------------------|
| Базовый контекст | Название, определение, цель, аудитория | "подтверждаю" или корректировка |
| [1] | Глоссарий, акторы, UC, границы | "продолжай этап [2]" |
| [2] | Стек, стандарт, методология | "продолжай этап [3]" |
| [3] | FR, NFR, приоритеты | "продолжай этап [4]" |
| [4] | Домены, границы, зависимости | "продолжай этап [5]" |
| [5] | Сценарии, события, BC | "продолжай этап [5.5]" |
| [5.5] | Диаграммы, Context Map | "продолжай этап [6]" |
| [6] | Модель данных, таблицы | "продолжай этап [7]" |
| [7] | BL/AL/TL, связи | "продолжай этап [7.1]" |
| [7.1] | ArchiMate диаграммы | "продолжай этап [8]" |
| [8] | Стек, структура, порты | "продолжай этап [9]" |
| [9] | Тесты, план испытаний | "документация завершена" |

---

## 6. Правила для агентов

1. **Сформулировать базовый контекст** — перед этапом [1] (см. 5.2.3). Получить подтверждение разработчика.
2. **Начинать с этапа 1** — не пропускать этапы.
3. **Проверять входы** — если предыдущий этап не завершен, зафиксировать это.
4. **Не галлюцинировать** — если данных нет, достроить или спросить (см. 5.2.4).
5. **Вести Gap Tracking** — пробелы фиксировать в `docs/requirements/gap-tracking.md`.
6. **Не редактировать `.requirements/**`** — только читать и копировать структуру.
7. **ОСТАНАВЛИВАТЬСЯ после каждого этапа** — см. раздел 5.2. Не переходить к следующему этапу без явной команды разработчика.
8. **Задачи `.tasks/` — только для кода** — при SDD задачи в `.tasks/` не создаются, используется только `gap-tracking.md`.

---

## 7. Gap Tracking (Трекинг пробелов)

**Цель:** отслеживание незавершенных и неполных артефактов документации.

### 7.1 Реестр пробелов

Агент создает файл `docs/requirements/gap-tracking.md` и ведет таблицу:

| GAP-ID | Этап | Артефакт | Описание пробела | Критичность | Блокирует | Статус | Задача |
|--------|------|----------|------------------|-------------|-----------|--------|--------|
| GAP-001 | [1] | Предметная область | Не определены границы системы | HIGH | [2], [3] | OPEN | TASK-001 |
| GAP-002 | [3] | Требования | Отсутствуют NFR по производительности | MEDIUM | [9] | IN_PROGRESS | TASK-005 |
| GAP-003 | [5] | Сценарии | Не описан happy path для UC-003 | LOW | - | RESOLVED | - |

### 7.2 Критичность пробелов

| Уровень | Описание | Действие |
|---------|----------|----------|
| `HIGH` | Блокирует несколько этапов | Требуется немедленное решение |
| `MEDIUM` | Блокирует 1 этап или влияет на качество | Решить до завершения текущего этапа |
| `LOW` | Не блокирует, но желательно устранить | Можно отложить |

### 7.3 Статусы пробелов

| Статус | Описание |
|--------|----------|
| `OPEN` | Пробел обнаружен, задача не создана |
| `IN_PROGRESS` | Создана задача, работа ведется |
| `BLOCKED` | Решение зависит от внешних факторов |
| `RESOLVED` | Пробел устранен |
| `WONTFIX` | Решено не устранять (с обоснованием) |

### 7.4 Автоматическое выявление пробелов

Агент ДОЛЖЕН проверять на наличие пробелов:

1. **При копировании шаблона:**
   - Секции с `<placeholder>` без значений
   - Ссылки на несуществующие документы
   - Пустые обязательные поля

2. **При переходе к следующему этапу:**
   - Незаполненные входы для следующего этапа
   - Отсутствующие зависимости

3. **При финальной проверке:**
   - Разрывы трассируемости (REQ без UC, UC без теста)
   - Несогласованность между артефактами

### 7.5 Формат записи в gap-tracking.md

```markdown
## Gap Tracking

> Последнее обновление: YYYY-MM-DD

### Статистика
- OPEN: N
- IN_PROGRESS: N
- BLOCKED: N
- RESOLVED: N (за последние 7 дней)

### Открытые пробелы

| GAP-ID | Этап | Артефакт | Описание | Критичность | Блокирует | Задача |
|--------|------|----------|----------|-------------|-----------|--------|
| ... | ... | ... | ... | ... | ... | ... |

### История (RESOLVED/WONTFIX)

| GAP-ID | Дата закрытия | Резолюция |
|--------|---------------|-----------|
| ... | ... | ... |
```

### 7.6 Разграничение gap-tracking и .tasks/

**При SDD (разработка документации):**
- Пробелы фиксируются ТОЛЬКО в `gap-tracking.md`
- Задачи в `.tasks/` НЕ создаются
- Колонка "Задача" в таблице остаётся пустой или содержит `—`

**При разработке кода (после SDD):**
- Задачи создаются в `.tasks/` по формату из `.manifest/taskmanifest.md`
- GAP из документации могут трансформироваться в задачи на код
- Связь: в задаче указывается ссылка на GAP-ID

**Почему так:**
- `gap-tracking.md` — инструмент отслеживания пробелов в документации
- `.tasks/` — инструмент планирования работ по коду (PR, коммиты, тесты)
- Смешивание усложняет оба процесса

---

## 8. Работа с диаграммами

### 8.1 Общие правила

Агент ОБЯЗАН соблюдать следующие правила при работе с диаграммами:

1. **Код диаграммы** сохраняется в отдельный файл `*.plantuml` или `*.mmd` (не inline в markdown)
2. **Рендеринг** выполняется агентом или CI/CD в формат PNG/SVG
3. **Ссылка на изображение** добавляется в markdown-документ
4. **Исходный код** и **картинка** хранятся рядом в папке `diagrams/`

### 8.2 Файловая структура диаграмм

```
docs/requirements/
  diagrams/                           # общие диаграммы предметной области
    domain-overview.plantuml
    domain-overview.png
  сценарии/
    <domain>/
      diagrams/                       # диаграммы конкретного домена
        UC-01-sequence.plantuml
        UC-01-sequence.png
        context-map.plantuml
        context-map.png
  архитектура/
    diagrams/                         # архитектурные диаграммы
      BL.plantuml
      BL.png
      AL.plantuml
      AL.png
      TL.plantuml
      TL.png
```

### 8.3 Именование файлов диаграмм

| Тип диаграммы | Формат имени | Пример |
|---------------|--------------|--------|
| Обзор домена | `<domain>-overview.plantuml` | `domain-overview.plantuml` |
| Sequence (UC) | `UC-<NN>-sequence.plantuml` | `UC-01-sequence.plantuml` |
| Activity (UC) | `UC-<NN>-activity.plantuml` | `UC-01-activity.plantuml` |
| Context Map | `context-map.plantuml` | `context-map.plantuml` |
| ArchiMate слой | `<layer>.plantuml` | `BL.plantuml`, `AL.plantuml`, `TL.plantuml` |
| ERD | `erd-<domain>.plantuml` | `erd-users.plantuml` |

### 8.4 Рендеринг диаграмм

**Вариант A: Локальный рендеринг (рекомендуется)**

```bash
# PlantUML (требуется Java + plantuml.jar)
java -jar plantuml.jar -tpng docs/requirements/diagrams/*.plantuml

# Или через Docker
docker run --rm -v $(pwd):/data plantuml/plantuml -tpng /data/docs/requirements/diagrams/*.plantuml
```

**Вариант B: CI/CD рендеринг**

Добавить шаг в пайплайн:
```yaml
# GitHub Actions пример
- name: Render PlantUML diagrams
  uses: cloudbees/plantuml-github-action@master
  with:
    args: -tpng docs/requirements/**/*.plantuml
```

**Вариант C: Онлайн-сервисы (для быстрого просмотра)**

- PlantUML Server: `http://www.plantuml.com/plantuml/png/~1<encoded>`
- Kroki: `https://kroki.io/plantuml/png/<encoded>`

### 8.5 Вставка диаграмм в документы

После рендеринга агент ОБЯЗАН добавить ссылку на изображение в markdown:

```markdown
### 12.1 Диаграмма событий

<!-- Исходный код: diagrams/domain-events.plantuml -->
![Диаграмма событий домена](diagrams/domain-events.png)
```

**Правила:**
- Комментарий с путём к исходному коду обязателен
- Alt-текст должен быть описательным
- Относительный путь от текущего документа

### 8.6 Чеклист работы с диаграммами

При создании диаграммы агент проверяет:

- [ ] Код сохранён в отдельный `*.plantuml` файл
- [ ] Файл находится в правильной папке `diagrams/`
- [ ] Имя файла соответствует конвенции (раздел 8.3)
- [ ] Диаграмма отрендерена в PNG
- [ ] В markdown добавлена ссылка на PNG
- [ ] Добавлен комментарий с путём к исходному коду
- [ ] Диаграмма рендерится без ошибок (проверить синтаксис)

---

## 9. Версионирование шаблонов

**Текущая версия набора шаблонов:** `1.2.0`

### 9.1 Реестр версий

| Шаблон | Версия | Последнее изменение |
|--------|--------|---------------------|
| трек разработки.md | 1.2.0 | 2026-01 |
| предметная область.md | 1.1.0 | 2026-01 |
| обоснование выбора.md | 1.1.0 | 2026-01 |
| требования_гост19.md | 1.0.0 | 2026-01 |
| требования_гост34.md | 1.0.0 | 2026-01 |
| определение доменов.md | 1.0.0 | 2026-01 |
| карта процесса.md | 1.0.0 | 2026-01 |
| каталог мероприятий.md | 1.0.0 | 2026-01 |
| ограниченные контексты.md | 1.0.0 | 2026-01 |
| диаграммы сценариев.md | 1.0.0 | 2026-01 |
| диаграммы Context Map.md | 1.0.0 | 2026-01 |
| описание БД.md | 1.0.0 | 2026-01 |
| описание BL/AL/TL.md | 1.0.0 | 2026-01 |
| описание связи TL AL BL.md | 1.0.0 | 2026-01 |
| сущности архитекутры.md | 1.0.0 | 2026-01 |
| диаграммы ArchiMate.md | 1.0.0 | 2026-01 |
| стек проекта.md | 1.0.0 | 2026-01 |
| файловая структура.md | 1.0.0 | 2026-01 |
| стек тестов.md | 1.0.0 | 2026-01 |
| испытание системы.md | 1.0.0 | 2026-01 |

### 9.2 Правила версионирования (SemVer)

- **MAJOR (X.0.0):** несовместимые изменения структуры шаблона
- **MINOR (0.X.0):** новые секции, обратно совместимые
- **PATCH (0.0.X):** исправления, уточнения формулировок

### 9.3 При обновлении шаблона

1. Обновить версию в этой таблице
2. Добавить запись в CHANGELOG (если ведется)
3. Проверить совместимость с уже созданными `docs/**` документами
