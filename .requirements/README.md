# Инструкция по написанию спецификаций

Спецификация — шаблон для создания технической документации на конкретном этапе разработки.
**Аудитория:** агенты, которые заполняют шаблоны на основе исходных данных из `.source/` и создают артефакты в `docs/requirements/`.

---

## 1) Иерархия H5-H6-H7 в .requirements/

Файлы в `.requirements/` организованы согласно [.manifest/hierarchymanifest.md](../.manifest/hierarchymanifest.md):

| Уровень | Назначение | Где находится | Пример |
|---------|-----------|---------------|--------|
| **H5** — Спецификация | Единственный файл последовательности этапов | `.requirements/трек разработки.md` | Трек разработки |
| **H6** — Процедура | Файлы процедур этапов документирования | `.requirements/предметная область.md`, `.requirements/обоснование выбора.md` и т.д. | Предметная область |
| **H7** — Описание | Разделы внутри файлов процедур | `## N.` внутри H6 файлов | "## 1. Составь глоссарий" |

### 1.1 H5: Спецификация последовательности (трек разработки)

**Единственный файл H5:** `.requirements/трек разработки.md`

**Содержит:**
- Перечень этапов [1]-[9] документирования
- Последовательность выполнения
- Ссылки на H6 процедуры
- Краткое описание входов/выходов каждого этапа

**Структура:**
```markdown
# Трек разработки (H5)

## 1. Последовательность этапов
[1] → [2] → [3] ...

## 2. Детализация этапов
### Этап [1]: Предметная область
**Процедура:** `.requirements/предметная область.md` (H6)
**Результат:** `docs/requirements/предметная область.md` (H8)
**Входы:** .source/
**Выходы:** Глоссарий, акторы, use cases
```

**Что НЕ включать в H5:**
- Детальные инструкции КАК создавать разделы (это в H6/H7)
- Примеры "Считать верным/неверным" (это в H7)
- Формат полей и таблиц (это в H7)

### 1.2 H6: Процедуры этапов

**Файлы процедур:**
- `.requirements/предметная область.md` (H6) - процедура этапа [1]
- `.requirements/обоснование выбора.md` (H6) - процедура этапа [2]
- `.requirements/требования/*.md` (H6) - процедуры этапа [3]
- И так далее для этапов [4]-[9]

**Каждый файл H6 содержит:**
- **H7 разделы:** Конкретные действия ("## 1. Составь глоссарий")
- Инструкции КАК создать итоговый документ (H8)
- Примеры "Считать верным/неверным"
- Шаблон структуры итогового документа

**Структура файла H6:**
```markdown
# Предметная область (H6)

Процедура этапа [1] из трека разработки.

**Входные данные:**
- Файлы в .source/

**Выходные данные:**
- docs/requirements/предметная область.md (H8)

---

## 1. Составь глоссарий (H7)

**Откуда брать:**
- Читай .source/
- Ищи специфичные термины домена

**Примеры:**
**Считать верным:**
**Заявка** — запрос пользователя на получение услуги с указанием типа и срока.
**Считать неверным:**
**Заявка** — документ.

**Формат в итоговом документе (H8):**
Создай в docs/requirements/предметная область.md раздел:
## 4. Доменная модель
### 4.1 Глоссарий
| Термин | Определение | Пример |
```

### 1.3 H7: Описания действий

**Уровень H7** - это разделы `## N.` внутри файлов процедур (H6).

Каждый раздел H7 описывает:
- КАК выполнить конкретное действие
- Откуда брать данные
- Примеры верного/неверного результата
- Формат записи в итоговом документе (H8)

---

## 2) Нумерация правил

Спецификации не нумеруются как манифесты (нет `<префикс>.H5.X`), но содержат структурированные разделы:

**Формат H6 (процедура):**
```markdown
## N. Название процедуры
```

**Формат H7 (описание):**
```markdown
### N.M Подпроцедура
**Что делать:**
- Действие 1
- Действие 2
```

**Пример структуры:**
```markdown
# Предметная область (H5)

Шаблон для этапа [1]: глоссарий, акторы, use cases, границы системы.

---

## 1. Составь глоссарий (H6)

Глоссарий фиксирует термины предметной области из .source/.

### 1.1 Извлечение терминов (H7)
**Что делать:**
- Прочитай все файлы в .source/
- Найди специфичные термины предметной области
- Исключи общетехнические термины (API, REST, JSON)

### 1.2 Формат записи (H7)
**Термин** — определение в 1-2 предложения.
```

---

## 3) Спецификация (H5) — шаблон этапа

**Назначение:**
Спецификация описывает:
- Цель этапа документирования
- Входные данные
- Структуру артефакта
- Критерии готовности

**Структура спецификации:**
```markdown
# <Название этапа> (H5)

Краткое описание цели этапа.

**Входные данные:**
- Что нужно для этапа

**Выходные данные:**
- Что создаем

---

## 1. Процедура 1 (H6)
Описание процедуры...

### 1.1 Действие (H7)
Детали...

## 2. Процедура 2 (H6)
...

---

## Критерии готовности
- [ ] Чеклист завершения
```

**Обязательные разделы:**
- Описание цели
- Входные/выходные данные
- Процедуры (H6)
- Критерии готовности

---

## 4) Процедура (H6) — последовательность шагов

**Назначение:**
Процедура описывает:
- Последовательность действий
- Источники данных
- Формат результата

**Правила написания:**
- Заголовок = императив ("Составь", "Определи", "Создай")
- Нумерация сквозная: 1, 2, 3...
- Краткое описание зачем нужна процедура (1-2 предложения)
- Детализация в подразделах (H7)

**Примеры хороших названий H6:**
- "1. Составь глоссарий"
- "2. Определи акторов"
- "3. Опиши use cases"
- "4. Зафиксируй границы системы"

**Неправильно:**
- ~~"1. Глоссарий"~~ (не процедура, а существительное)
- ~~"2. Работа с акторами"~~ (неконкретно)
- ~~"3. Use cases системы"~~ (не действие)

---

## 5) Описание (H7) — детальные действия

**Назначение:**
Описание содержит:
- Конкретные шаги выполнения
- Примеры форматов
- Критерии качества

**Правила написания:**
- Используй подразделы `### N.M`
- Группируй связанные действия
- Давай примеры форматов
- Указывай источники данных

**Типичные подразделы H7:**
```markdown
### N.1 Извлечение данных
Откуда брать информацию

### N.2 Формат записи
Как оформлять результат

### N.3 Критерии качества
Как проверить правильность

### N.4 Примеры
**Считать верным:**
<хороший пример>

**Считать неверным:**
<плохой пример>
```

---

## 6) Разграничение уровней H5/H6/H7

| Критерий | H5 (Спецификация) | H6 (Процедура) | H7 (Описание) |
|----------|-------------------|----------------|---------------|
| Масштаб | Весь этап | Одна задача этапа | Конкретные шаги |
| Заголовок | Название этапа | Императивная задача | Аспект выполнения |
| Содержание | Структура этапа | Что сделать | Как именно сделать |
| Пример | "Предметная область" | "Составь глоссарий" | "Извлечение терминов" |
| Файл | `.requirements/*.md` | `## N.` раздел | `### N.M` подраздел |

**Правильная вложенность:**
```markdown
# Предметная область (H5)
  ↓
## 1. Составь глоссарий (H6)
  ↓
### 1.1 Извлечение терминов (H7)
### 1.2 Формат записи (H7)
```

**Неправильно (отсутствует H6):**
```markdown
# Предметная область (H5)
  ↓
### 1.1 Извлечение терминов (H7) ← пропущен H6
```

---

## 7) Императивный стиль для процедур

**Процедуры (H6) пиши императивно:**
- "Составь глоссарий"
- "Определи акторов"
- "Опиши use cases"
- "Создай диаграмму"

**Избегай пассивных конструкций:**
- ~~"Составление глоссария"~~
- ~~"Определение акторов"~~
- ~~"Описание use cases"~~

**Описания (H7) могут использовать существительные:**
- "### 1.1 Извлечение терминов" (допустимо)
- "### 1.2 Формат записи" (допустимо)

Но действия внутри H7 — императив:
```markdown
### 1.1 Извлечение терминов
**Что делать:**
- Прочитай .source/
- Найди термины
- Исключи общетехнические
```

---

## 8) Примеры "Считать верным/неверным"

Каждая процедура должна содержать примеры качественного и некачественного результата.

**Формат:**
```markdown
## 2. Определи акторов

### 2.3 Примеры

**Считать верным:**
**Администратор** — управляет пользователями системы, назначает роли, настраивает политики доступа.
- Может: создать пользователя, удалить, заблокировать
- Не может: редактировать контент пользователей

**Считать неверным:**
**Администратор** — управляет системой.
```

**Почему нужны примеры:**
- Агент видит целевой уровень детализации
- Избегаются слишком общие формулировки
- Обеспечивается единообразие артефактов

---

## 9) Критерии готовности

Каждая спецификация должна содержать чеклист готовности этапа.

**Формат:**
```markdown
## Критерии готовности

- [ ] Глоссарий содержит >= 10 терминов предметной области
- [ ] Каждый термин имеет определение в 1-2 предложения
- [ ] Определены >= 3 актора с ролями и полномочиями
- [ ] Описаны >= 5 use cases с шагами
- [ ] Зафиксированы границы системы (scope in/out)
- [ ] Нет placeholder'ов "Не определено"
```

**Критерии должны быть:**
- Измеримыми (>= N элементов)
- Проверяемыми (можно ответить да/нет)
- Специфичными для этапа

---

## 10) Входные и выходные данные

Каждая спецификация указывает:

**Входные данные:**
```markdown
**Входные данные:**
- Файлы в `.source/` (идеи, требования заказчика)
- Результаты предыдущих этапов (если применимо)
```

**Выходные данные:**
```markdown
**Выходные данные:**
- `docs/requirements/предметная область.md`
- Обновления в `docs/requirements/gap-tracking.md` (если есть пробелы)
```

---

## 11) Трассируемость к треку разработки

Спецификация связана с этапом в `.requirements/трек разработки.md`:

**Трек разработки (H5):**
```markdown
### [1] Предметная область
**Шаблон:** `.requirements/предметная область.md`
**Артефакт:** `docs/requirements/предметная область.md`
```

**Спецификация (H5):**
```markdown
# Предметная область

Этап [1] из трека разработки.
```

Спецификация — это развернутый шаблон этапа из трека.

---

## 12) Чеклист самопроверки спецификации

- [ ] Заголовок содержит (H5)?
- [ ] Указаны входные/выходные данные?
- [ ] Процедуры (H6) написаны императивно?
- [ ] Каждая процедура детализирована в H7?
- [ ] Есть примеры "Считать верным/неверным"?
- [ ] Есть раздел "Критерии готовности"?
- [ ] Критерии измеримые и проверяемые?
- [ ] Нет теоретических обоснований?
- [ ] Понятно агенту что делать на каждом шаге?

---

## 13) Примеры хороших спецификаций

| Спецификация (H5) | Процедуры (H6) | Описания (H7) |
|-------------------|----------------|---------------|
| Предметная область | Составь глоссарий | Извлечение терминов, Формат записи |
| Обоснование выбора | Обоснуй стек | Критерии выбора, Альтернативы |
| Домены | Определи домены | Bounded contexts, Owned data |
| Сценарии | Составь карту процесса | События, Команды, Use cases |

---

## 14) Ограничения по объему

| Объем спецификации | Статус | Действие |
|-------------------|--------|----------|
| до 200 строк | Оптимально | — |
| 200-300 строк | Допустимо | — |
| 300-400 строк | Предупреждение | Проверить детализацию |
| 400+ строк | Превышение | Разделить на подэтапы |

**Если спецификация превышает 400 строк:**
1. Проверить избыточность описаний (H7)
2. Вынести примеры в отдельный файл
3. Разделить на подэтапы (если возможно)

---

## 15) Автономность спецификаций

Спецификации — **автономные** шаблоны:
- НЕ зависят от манифестов `.manifest/`
- Могут ссылаться на другие спецификации (предыдущие этапы)
- Читаются агентом при выполнении конкретного этапа

**Допустимые ссылки:**
- На предыдущие этапы: "Используй акторов из этапа [1]"
- На трек разработки: "Этап [4] из `.requirements/трек разработки.md`"
- На gap-tracking: "При пробелах создай GAP в `docs/requirements/gap-tracking.md`"

**Недопустимые ссылки:**
- На манифесты: ~~"Следуй правилам из `.manifest/sddmanifest.md`"~~ (агент уже знает манифесты)
- На внешние ресурсы без контекста

---

## 16) Распределение ответственности между H6

**Проблема:** Первые H6 процедуры перегружаются информацией, а последующие остаются "пустыми" или дублируют уже описанное.

**Правило:** Каждая H6 процедура отвечает ТОЛЬКО за свою область. Информация не дублируется между этапами.

### 16.1 Принцип разделения

| Этап | H6 процедура | Область ответственности | Что НЕ включать |
|------|--------------|------------------------|-----------------|
| [1] | Предметная область | Базовое понимание домена | NFR, метрики, события, BC |
| [2] | Обоснование выбора | Технические решения, NFR, ограничения | Детали реализации |
| [3] | Требования | Формализованные FR/NFR | Архитектура |
| [4] | Домены | Bounded Contexts, детальные сущности | События и команды |
| [5] | Сценарии | События, команды, агрегаты | Структура данных |
| [6] | Структура данных | Модель данных, схемы | Код |
| [7] | Архитектура | Слои, компоненты | Файловая структура |
| [8] | Структура ПО | Модули, зависимости | Тесты |
| [9] | Тестирование | Стратегия, план тестов | - |

### 16.2 Уровни детализации

**Базовый уровень (ранние этапы):**
- Этап [1]: Термины, акторы, UC (верхнеуровневые), сущности (список)
- Этап [2]: Решения, стек, методология
- Этап [3]: FR/NFR формализованные

**Детальный уровень (поздние этапы):**
- Этап [4]: Детальные сущности, state machine, инварианты
- Этап [5]: События, команды, агрегаты
- Этап [6]: Атрибуты, связи, индексы

### 16.3 Правила написания H6

**При написании H6 процедуры:**
1. Укажи в начале "Что НЕ входит в этот этап" со ссылками на нужные этапы
2. В каждом H7 добавь "Примечание" если детализация происходит позже
3. Не дублируй примеры из других H6
4. Ссылайся на предыдущие этапы для входных данных

**Формат указания границ:**
```markdown
**Что НЕ входит в этот этап (детализируется позже):**
- NFR/метрики/ограничения -> [2] Обоснование выбора, [3] Требования
- Детальные события и команды -> [5] Сценарии
- Bounded Contexts -> [4] Домены
```

**Формат примечания в H7:**
```markdown
**Примечание:** Детальные атрибуты, state machine, инварианты - на этапах [4] Домены и [6] Структура данных.
```

### 16.4 Таблица распределения информации

| Информация | Базовый уровень | Детальный уровень |
|------------|-----------------|-------------------|
| Термины | [1] Глоссарий (определение + пример) | - |
| Акторы | [1] Роль, цели, боли | [7] Каналы взаимодействия |
| Use Cases | [1] Верхнеуровневые (3+ шагов) | [5] С событиями и командами |
| Сущности | [1] Список с описанием | [4] State machine, инварианты |
| Правила | [1] Базовые бизнес-правила | [4] Детальные с исключениями |
| NFR | - | [2] Критерии, [3] Формализованные |
| Метрики | - | [2] Целевые, [3] Измеримые |
| События | - | [5] Event Storming |
| BC | - | [4] Домены |
| Данные | - | [6] Схема, атрибуты |

### 16.5 Чеклист при создании H6

- [ ] Определена область ответственности этого этапа
- [ ] Указано "Что НЕ входит" в начале файла
- [ ] Нет дублирования с другими H6
- [ ] Ссылки на последующие этапы для детализации
- [ ] Базовый уровень для ранних этапов, детальный для поздних
