# Шаблон: Стек тестов

> **Важно:** этот файл — шаблон (read-only), используется агентом/разработчиком как исходная структура для `docs/requirements/тестирование/стек тестов.md`.
> Заполненная версия сохраняется в: `docs/requirements/тестирование/стек тестов.md`.

---

## 0. Мета (контекст)
- **Цель:** описать стратегию тестирования проекта: уровни тестов, инструменты, окружение, CI/CD, критические сценарии регрессии.
- **Источники фактов:** `docs/requirements/структура ПО/стек проекта.md`, `docs/requirements/сценарии/**`, `docs/requirements/требования/**`.

> **Правило для агента:** не придумывай факты; извлекай инструменты, сервисы и сценарии из источников. При отсутствии данных фиксируй `Не определено` и создавай задачу в `.tasks/<id>`.

---

## 1. Структура документа (обязательные разделы)
1. Заголовок + Контекст (п.0)
2. Уровни тестирования (таблица)
3. Для каждого уровня — инструменты, команды запуска, окружение, acceptance criteria
4. CI/CD: job'ы, порядок запуска, артефакты, полисы хранения
5. Окружение и тестовые данные (ports, profiles, seed data)
6. Критические сценарии регрессии (список + приоритет)
7. Edge cases / тест-кейсы (структурированный формат)
8. Метрики и целевые показатели (SLA)
9. Чеклист готовности (What must be present)
10. Appendices: test accounts, команды запуска, docker-compose example

---

## 1.1 Связь со структурой ПМИ
- **Как читать ПМИ:** ПМИ (`docs/requirements/тестирование/испытание системы.md`) содержит приёмочные критерии и реестр проверок `T-###` с методиками. Этот документ (Стек тестов) описывает, **какими уровнями и наборами** каждая проверка `T-###` будет реализована.
- **Требование:** для каждой `T-###` необходимо указать: основной уровень (unit/integration/e2e/...), основной `suite`, тип выполнения (`auto|manual|mixed`), ожидаемые артефакты и требуемое окружение; ссылка на методику в ПМИ должна быть явно указана в маппинг-таблице.
- **Если ПМИ ещё не содержит `T-###`:** агент создаёт пустой шаблон маппинга и помечает задачи `.tasks/<id>` для заполнения.

---

## 2. Уровни тестирования — таблица (шаблон)
| Уровень | Область | Цель |
|---------|--------:|------|
| Unit | `{components}` | Мелкие юниты и функции |
| Integration / API | `{service ↔ datastore}` | Контракты, интеграции |
| E2E / UI | `{PWA/backend}` | Путь пользователя, сценарии |
| Performance | `{api, db, queues}` | SLA, throughput |
| Security | `{auth, input_validation}` | Авторизация, защита от инъекций |
| Regression | `release` | Критические бизнес-сценарии |

> Агент подставляет `{...}` из `docs/requirements/структура ПО/стек проекта.md` и `docs/requirements/сценарии/**`.

---

## 2.1 Наборы тестов (suites) и правила маппинга на `T-###`

### Определение
Набор тестов (suite) — логическая группа тестов одного уровня, запускаемая как единое целое.

### Правила маппинга
- Каждой проверке `T-###` в ПМИ должен соответствовать как минимум один основной набор (suite) и уровень; при необходимости добавляются дополнительные наборы.
- В маппинг-таблице указывать: `ID проверки (T-###) | Уровень | Набор (suite) | Тип выполнения (auto/manual/mixed) | Где описано выполнение (ссылка на ПМИ) | Артефакты`.
- Агент обязан сгенерировать пустую маппинг-таблицу, если ПМИ не содержит `T-###`.

**Шаблон таблицы маппинга (заполняется проектом):**

| ID проверки (из ПМИ) | Уровень | Набор тестов (suite) | Тип выполнения (auto/manual/mixed) | Где описано выполнение | Артефакты |
|---|---|---|---|---|---|
| T-___ | ___ | ___ | ___ | ссылка на методику в ПМИ | ___ |

---

## 3. Формат описания уровня (шаблон)
### {Уровень}: {Короткое название}
- **Tools:** `{список инструментов}`
- **Run:** `{как запускать}` (примеры: `npm test`, `cargo test --release`)
- **Env:** `{docker-compose profile:test}`; порты: `{список}`
- **Artifacts:** `{junit, coverage, perf-report}`
- **Acceptance criteria:** `{проход/порог}`
- **Owner:** `{team/person}`

---

## 4. Шаблон тест-кейса (edge / regression)
ID: `{prefix}::{short_id}`
Title: `{короткое название}`
Priority: `{P0|P1|P2}`
Description: `{что проверяем}`
Preconditions: `{seed data, accounts}`
Steps / Scenario:
1. `{действие}`
2. `{...}`
Expected result: `{что должно быть}`
Implementation: `{unit/integration/e2e/perf/security}`
Mocks: `{что мокать}`
Data: `{файл/seed}`
CI job: `{job-name}`
Owner: `{team/person}`
Notes: `{flaky? retry? timeouts?}`

---

## 4. Структура тестов в репозитории (универсально)
Цель раздела: унифицировать размещение тестов и данных, чтобы агент мог автоматически сопоставлять наборы и артефакты.

Рекомендуемые принципы:
- тесты организованы по уровням: `unit/`, `component/`, `integration/`, `contract/`, `e2e/`, `perf/`, `stability/`, `security/`, `regression/`;
- общие фикстуры и генераторы данных: `testdata/`, `fixtures/`, `mocks/` (или аналог, указанный в проекте);
- результаты и артефакты собираются централизованно: `artifacts/<build-or-release>/...`;
- конфигурации окружений и docker-compose профили хранить в `ci/` или `deploy/` с явными именами профилей (например `test`, `staging`).
- В README набора (например `integration/README.md`) указывать команду запуска, параметры окружения и пример ожидаемых артефактов.

---

## 5. CI/CD и автоматизация (рекомендации)
- Рекомендуемые job'ы и порядок:
  1. `lint/static` — статический анализ, линтеры.
  2. `unit` — быстрые тесты, обязательны на merge.
  3. `integration` — запускается в CI с профилем `test` (с необходимыми БД/сервисами).
  4. `e2e` — на `staging`/test-stand для сквозных сценариев.
  5. `regression` — сборный набор перед релизом.
  6. `perf`/`stability`/`security` — отдельные прогонки по расписанию или по запросу.
- Политика блокировок:
  - Провал `unit`/`integration`/`regression` (P0/P1) блокирует merge/release по правилам проекта.
  - Флаки тесты: маркировать `flaky`, переводить в карантин и создавать задачу на их фиксацию; повторные флаки — блокировать ветку/задание.
- Артефакты:
  - Ошибки и отчёты сохранять в JUnit/HTML/JSON/coverage; хранить `artifacts/<release>/...` и обеспечить доступность для верификации ПМИ.
- Трекеры/триггеры:
  - Авто-триггер на PR для `lint`+`unit`; nightly прогон `integration`/`e2e` для мониторинга стабильности.


---

## 6. Окружение и тестовые данные
- `docker-compose profile: test` — перечислить сервисы и порты
- Seed data: `datasets/` — схемы, шаблоны, тестовые аккаунты
- Тестовые учётки: перечислить (`student1@test`, `teacher1@test`, `admin@test`) или аналог
- Для perf — отдельный сервер (указать CPU/RAM)

---

## 6.1 Тестовые данные (правила)
- Источник тест-данных должен быть описан и разрешён в `docs/` или отмечен как `Не задано в docs` и сопровождается задачей `.tasks/<id>`.
- Данные воспроизводимы (seed/генерация), изолируемы (уникальные префиксы/неймспейсы) и конфиденциальные данные маскируются/не используются.
- Для E2E определяются тестовые роли/учётки и процедуры их подготовки в отдельном документе (например `docs/requirements/тестовые_аккаунты.md`).

## 6.2 Артефакты и привязка к ПМИ
- Каждому `T-###` в реестре ПМИ должен соответствовать набор артефактов, позволяющих подтвердить pass/fail (лог, дамп, отчёт, скриншот и т.д.).
- Формат и путь артефактов должны быть заранее согласованы (например `artifacts/<T-###>/<run-id>/...`) и указаны в стеке/CI.
- Если ПМИ требует специфический артефакт — стек обязан описать метод получения и хранение; если не задано — пометить `Не задано в docs`.

---

## 7. Метрики и SLA (шаблон таблицы)
| Метрика | Целевое значение | Сценарий тестирования |
|---------|------------------:|----------------------|
| Latency (p95) | `<= 100 ms` | `perf::...` |
| Availability | `>= 99.5%` | Synthetics |
| Error rate | `<= 0.1%` | Logging + dashboards |
| Test coverage | Unit >= 80% (если принято) | Coverage reports |
| Покрытие требований (PМИ) | `% проверок T-### покрыто` | Сопоставление PМИ ↔ наборы |
| Стабильность тестов | `% flaky < threshold` | CI dashboards |

> **Примечание:** пороги покрытий/метрик задаются в `docs` или фиксируются в стеке при согласовании; агент не придумывает чисел без источника.

---

## 8. Чеклист готовности
- [ ] Уровни тестирования описаны
- [ ] Для каждого уровня указан инструмент и команда запуска
- [ ] CI job'ы привязаны к тест-кейсам
- [ ] Тестовые данные и окружение описаны
- [ ] Критические сценарии и edge-cases перечислены
- [ ] Маппинг таблица ПМИ ↔ наборы (раздел 2.1) создана/заполнена
- [ ] Структура репозитория соответствует рекомендациям (раздел 4)
- [ ] Артефакты привязаны к T-### и пути указаны
- [ ] Политика хранения артефактов и блокировок CI описана

---

## 9. Правила для агента
- **Не придумывать**: извлекать факты только из `docs/requirements/структура ПО/стек проекта.md`, `docs/requirements/сценарии/**`, `docs/requirements/требования/**`. Если данных нет — писать `Не определено` и создавать задачу `.tasks/<id>` с указанием перечня проверенных документов.
- **Генерация маппинга:** агент обязан сформировать `docs/requirements/тестирование/маппинг_PMI_на_наборы.md` (или добавить таблицу в основной файл) и `docs/requirements/тестирование/маппинг.json`/`yaml` (машинно-парсимый), даже если таблица пустая.
- **Не выбирать инструменты жестко:** нельзя навязывать конкретные инструменты, только указывать примеры и способы запуска; конкретный инструмент отмечать как `пример`.
- **Артефакты:** если ПМИ требует артефакт — агент указывает формат и рекомендуемый путь хранения (`artifacts/<T-###>/...`); если не задано — помечает `Не задано в docs`.
- Каждый файл в `.requirements/тестирование/` должен содержать минимальный каркас: header + чеклист + ссылки на связанные ПМИ/T-###.

---

## 10. Пример-короткий сниппет (для быстрого заполнения)
```markdown
### Unit: Frontend (PWA)
- Tools: Vitest, @web/test-runner
- Run: `npm run test:unit`
- Env: node v18, TS strict
- Acceptance: coverage >= 80%
```
