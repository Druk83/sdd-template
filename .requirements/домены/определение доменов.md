# Определение доменов в проекте

## 0. Назначение
Этот документ определяет, **как в проекте выделяются домены** (bounded contexts / области ответственности).

Домены фиксируются **до** сценариев и служат основанием для структуры:
- `docs/requirements/сценарии/<domain_slug>/...`

Разделение “правила/данные”:
- `.requirements/**` — **правила и входные материалы этапа** (шаблоны/методика)
- `docs/**` — **фактические результаты этапов** (используются далее как вход)

**Источник истины по доменам после выполнения этапа:**
- `docs/requirements/домены/**` (реестр + карточки доменов)

---

## 1. Допустимые источники для первичного выделения доменов (ТОЛЬКО)
Первичное выделение доменов выполняется **строго** на основании:

1) `docs/requirements/предметная область.md`
2) `docs/requirements/обоснование выбора.md`
3) `docs/requirements/требования/**`

Запрещено выделять домены по:
- предположениям,
- “типовым” доменам,
- внешним шаблонам,
- сценариям (сценарии идут ПОСЛЕ доменов),
- уже сгенерированным сценариям из `docs/requirements/сценарии/**`.

Если данных недостаточно — домен помечается `draft`, а пробел фиксируется в разделе “Пробелы”.

---

## 2. Определение домена (в терминах проекта)

### 2.1 Терминология (Домен vs Bounded Context)

| Термин | Определение | Уровень | Пример |
|--------|-------------|---------|--------|
| **Домен (Domain)** | Высокоуровневая бизнес-область с единым языком и ответственностью | Стратегический | `orders`, `users`, `payments` |
| **Bounded Context (BC)** | Технический подконтекст внутри домена с чёткими границами модели | Тактический | `order-processing`, `order-fulfillment` |

**Правила:**
- Один **домен** может содержать **один или несколько BC**
- Для простых систем: 1 домен = 1 BC (не выделяем подконтексты отдельно)
- Для сложных систем: 1 домен = N BC (разбиваем по ответственности)
- BC определяются **после** доменов, на этапе сценариев (`.requirements/сценарии/ограниченные контексты.md`)

### 2.2 Признаки домена

**Домен** — это область ответственности, в которой:
- есть свой набор терминов/сущностей,
- есть бизнес-функции (кластер требований),
- есть владение данными/инварианты,
- минимизируются пересечения изменений с другими доменами.

---

## 3. Куда сохраняются результаты (выходные артефакты)
Все результаты этапа "Определение доменов" сохраняются **только** в:

- `docs/requirements/домены/`

### 3.1 Реестр доменов (обязателен)
Создаётся файл:
- `docs/requirements/домены/реестр.md`

Содержит список доменов и их статус.

### 3.2 Карточка домена (обязательна для каждого домена)
Для каждого домена создаётся файл:
- `docs/requirements/домены/<domain_slug>.md`

`<domain_slug>` — стабильный идентификатор домена латиницей (пример: `auth`, `billing`, `catalog`).

---

## 4. Формат карточки домена (минимальный)
Каждый домен `docs/requirements/домены/<domain_slug>.md` обязан содержать:

- `slug`: стабильный идентификатор домена
- `title`: человекочитаемое имя
- `type`: `core | supporting | generic`
- `status`: `draft | active | deprecated`
- `scope_in`: что входит в домен (функции/ответственность)
- `scope_out`: что явно НЕ входит
- `actors`: ключевые участники (если явно указаны)
- `owned_data`: какие данные/сущности “владеет” домен (если выводится из требований/данных)
- `requirements_refs`: ссылки на `docs/requirements/требования/**` (пути или ID), которые покрывает домен
- `interfaces`: взаимодействия с другими доменами (если явно следуют из требований)

Если пункт нельзя заполнить из источников — писать `Не определено источниками`.

---

## 4.1 Пример заполнения карточки домена

> **Важно:** Примеры ниже носят иллюстративный характер. Содержимое карточки домена
> (название, сущности, интерфейсы) должно определяться на основе предметной области
> и требований конкретного проекта, а не копироваться из примера.

### Считать верным: Достаточная детализация

```markdown
# Домен: Order Management

- **slug:** order-management
- **title:** Order Management
- **type:** core
- **status:** active
- **scope_in:**
  - Создание и валидация заказов
  - Управление жизненным циклом заказа (draft -> confirmed -> paid -> shipped -> completed)
  - Расчёт стоимости и применение скидок
  - Резервирование товаров при создании заказа
- **scope_out:**
  - Обработка платежей (домен payments)
  - Управление складом и отгрузкой (домен fulfillment)
  - Управление каталогом товаров (домен catalog)
- **actors:**
  - Customer — создаёт и отменяет заказы
  - Sales Manager — управляет заказами, применяет ручные скидки
  - System (автоматизация) — проверяет наличие, рассчитывает стоимость
- **owned_data:**
  - Order (aggregate root): id, status, items, total, discounts
  - OrderItem: productId, quantity, price, discount
  - OrderHistory: transitions, timestamps, actor
- **requirements_refs:**
  - FR-001: Создание заказа
  - FR-002: Отмена заказа
  - FR-003: Применение скидок
  - FR-010: История изменений заказа
  - NFR-002: Время ответа < 200ms
- **interfaces:**
  - -> catalog: запрос цен и наличия (sync API)
  - -> payments: инициация платежа (async event: OrderConfirmed)
  - <- payments: получение статуса (async event: PaymentCompleted)
  - -> fulfillment: запрос отгрузки (async event: OrderPaid)
```

### Считать неверным: Недостаточная детализация

```markdown
# Домен: Orders

- **slug:** orders
- **title:** Orders
- **type:** core
- **status:** active
- **scope_in:** работа с заказами
- **scope_out:** всё остальное
- **actors:** пользователи
- **owned_data:** заказы
- **requirements_refs:** FR-001, FR-002
- **interfaces:** взаимодействует с другими доменами
```

**Почему неверно:**
- `scope_in` не раскрывает конкретные функции
- `scope_out` не определяет границы с соседними доменами
- `actors` не указывает роли и их цели
- `owned_data` не перечисляет сущности и атрибуты
- `interfaces` не описывает направление и тип взаимодействия

---

## 4.2 Минимальные критерии детализации карточки

| Поле | Минимум | Как проверить |
|------|---------|---------------|
| `scope_in` | >= 3 конкретных функции/ответственности | Каждый пункт — глагол + объект |
| `scope_out` | >= 2 явных исключения с указанием домена-владельца | Указано, кто владеет исключённым |
| `actors` | >= 1 актор с описанием роли | Для каждого актора — что он делает в домене |
| `owned_data` | >= 1 сущность с ключевыми атрибутами | Перечислены поля, не только название |
| `requirements_refs` | >= 2 ссылки на FR/NFR | ID требований из docs/requirements/требования/ |
| `interfaces` | >= 1 связь с другим доменом (если не изолирован) | Указан тип (sync/async) и направление |

**Правило:** если карточка не проходит минимум — агент ОБЯЗАН детализировать до перехода к этапу [5].

---

## 5. Процедура выделения доменов (кратко и проверяемо)

### Шаг A. Кандидаты из предметной области
Из `docs/requirements/предметная область.md` выписать:
- ключевые сущности/термины,
- ключевые процессы/цели,
- акторов/роли (если есть),
и сгруппировать по смысловой близости.

### Шаг B. Приоритизация и ограничения
Из `docs/requirements/обоснование выбора.md` извлечь:
- приоритеты/критерии,
- критические ограничения,
и пометить, какие группы ближе к `core`, а какие — `supporting/generic`.

### Шаг C. Кластеризация требований
Из `docs/requirements/требования/**`:
- сгруппировать функциональные требования по “ответственности” и “данным”,
- для каждого кластера определить домен-владелец.

Правило: **каждое требование должно быть отнесено к одному домену**
или помечено как `generic`, если оно относится ко всем.

### Шаг D. Проверка границ
Для каждого домена проверить:
- нет ли "владения всем подряд",
- нет ли дублирования ответственности.

Если конфликт — домены уточняются или один из них помечается `draft` до уточнения требований.

### Шаг E. Подтверждение кандидатов (ОБЯЗАТЕЛЬНО)

> **Критически важно:** Агент НЕ создает детальные карточки доменов без подтверждения разработчика.

После шагов A-D агент ОБЯЗАН:

1. **Сформировать список кандидатов** — перечень доменов с кратким обоснованием
2. **Вывести блок подтверждения** в формате ниже
3. **Ожидать ответа** разработчика
4. **После подтверждения** — создавать детальные карточки

**Формат блока подтверждения:**

```
КАНДИДАТЫ ДОМЕНОВ — ТРЕБУЕТСЯ ПОДТВЕРЖДЕНИЕ

На основе анализа предметной области и требований выделены домены:

1. <domain-slug-1> (<type>)
   - Ответственность: <краткое описание>
   - Покрывает FR: <список>
   - Обоснование: <почему выделен как отдельный домен>

2. <domain-slug-2> (<type>)
   - Ответственность: <краткое описание>
   - Покрывает FR: <список>
   - Обоснование: <почему выделен>

Связи между доменами:
- <domain-1> -> <domain-2>: <тип связи>

Альтернативные варианты (если есть):
- Вариант A: объединить <domain-1> и <domain-2> потому что <причина>
- Вариант B: разделить <domain-1> на <sub-1> и <sub-2> потому что <причина>

Пожалуйста, подтвердите список или укажите корректировки.
```

**Почему это важно:**
- Домены — фундамент для сценариев [5] и всей последующей документации
- Ошибка в выделении доменов каскадно влияет на все артефакты
- Разработчик знает контекст проекта лучше, чем агент может вывести из документов

**После подтверждения:**
- Агент создает `docs/requirements/домены/реестр.md`
- Агент создает карточки `docs/requirements/домены/<slug>.md` для каждого домена
- Карточки заполняются по критериям раздела 4.2

---

## 6. Правила наименования и стабильности
- `domain_slug` **не меняется** при переименовании `title`.
- В путях и ссылках используем **только slug**.
- Домены в реестре сортируются по `type` и `slug`.

---

## 7. Пробелы и неопределённости (обязательный раздел)
Если по источникам нельзя корректно выделить домены, фиксировать:
- какие требования не кластеризуются,
- какие термины двусмысленны,
- какие границы не определены.

Рекомендуемый выходной файл (если нужно):
- `docs/requirements/домены/gaps.md`

---

## 8. Связь со сценариями
Сценарии формируются **только после** фиксации доменов в:
- `docs/requirements/домены/реестр.md`
- `docs/requirements/домены/<domain_slug>.md`

Для каждого домена создаётся папка сценариев:
- `docs/requirements/сценарии/<domain_slug>/`

Минимальный набор файлов внутри домена описан в:
- `.requirements/сценарии/правила.md`

---

## 9. Запрет на запись в `.requirements/**`
Агентам и автоматическим генераторам запрещено:
- создавать файлы,
- изменять файлы,
- перемещать файлы

внутри `.requirements/**`.

Результаты сохраняются только в `docs/**`.

---

## 10. Чеклист готовности этапа [4]

> **Обязательно:** агент проверяет этот чеклист перед переходом к этапу [5].

### 10.1 Минимальные критерии (блокируют переход)

- [ ] **Реестр доменов создан:** `docs/requirements/домены/реестр.md` существует
- [ ] **Количество доменов:** >= 1 домен со статусом `active`
- [ ] **Карточки доменов:** для каждого домена в реестре есть файл `<slug>.md`
- [ ] **Детализация карточек:** каждая карточка проходит критерии из раздела 4.2
- [ ] **Покрытие требований:** каждый FR из [3] отнесён к домену (проверить `requirements_refs`)
- [ ] **Границы определены:** для каждого домена `scope_out` указывает соседей

### 10.2 Валидация связности

- [ ] **Нет "бога":** ни один домен не владеет > 50% требований
- [ ] **Нет дублирования:** одно требование не присутствует в `requirements_refs` двух доменов
- [ ] **Интерфейсы симметричны:** если домен A указывает `-> B`, то домен B должен знать об этом

### 10.3 Правила извлечения данных для этапа [4]

| Откуда | Что извлекать | Куда в карточке |
|--------|---------------|-----------------|
| Предметная область, раздел 3 (Actors) | Роли и их цели | `actors` |
| Предметная область, раздел 4 (Сущности) | Entities, атрибуты | `owned_data` |
| Предметная область, раздел 7 (Границы) | BC и их ответственность | `scope_in`, `scope_out` |
| Требования, FR-* | Функции | `scope_in`, `requirements_refs` |
| Требования, NFR-* | Ограничения | `requirements_refs` |
| Обоснование выбора | Приоритеты | `type` (core/supporting/generic) |

### 10.4 Формат отчёта о завершении этапа [4]

```
---
ЭТАП [4] ЗАВЕРШЕН

Созданные артефакты:
- docs/requirements/домены/реестр.md
- docs/requirements/домены/<slug1>.md
- docs/requirements/домены/<slug2>.md
- ...

Статистика:
- Доменов: N (core: X, supporting: Y, generic: Z)
- Покрыто FR: M из K
- Связей между доменами: P

Чеклист готовности:
- [x] Реестр создан
- [x] Карточки созданы
- [x] Детализация достаточна
- [x] Требования покрыты
- [x] Границы определены

Найденные пробелы: N (см. gap-tracking.md)

ОЖИДАЮ ПОДТВЕРЖДЕНИЯ для перехода к этапу [5]
---
```
