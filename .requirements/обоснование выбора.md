# Обоснование выбора (H6)

Процедура этапа [2] из `.requirements/трек разработки.md`.

> **Важно:** это **шаблон** (read-only) в `.requirements/**`.
> Заполненная версия документа ведётся в: `docs/requirements/обоснование выбора.md`.
> Результаты фиксируются только в `docs/**`, шаблоны не изменяем.

---

**Входные данные:**
- `docs/requirements/предметная область.md` (результат этапа [1])
- `.source/` (ТЗ, договоры, ограничения)

**Выходные данные:**
- `docs/requirements/обоснование выбора.md` (H8)

---

**Что НЕ входит в этот этап (детализируется позже):**
- Формализованные FR/NFR с метриками -> [3] Требования
- Bounded Contexts, детальные сущности -> [4] Домены
- События, команды, агрегаты -> [5] Сценарии
- Схема данных, атрибуты -> [6] Структура данных
- Слои, компоненты приложения -> [7] Архитектура

---

**Подход:** перед заполнением разделов сформулируй кандидатов решений и согласуй с разработчиком (см. `sddmanifest.md` sdd.H4.10).

---

## Правила извлечения данных

| Откуда | Что извлекать | Куда |
|--------|---------------|------|
| `.source/` (ТЗ, договор) | Отрасль, требования к стандартам | Раздел 1.2 |
| `.source/` (ТЗ) | NFR, SLA, ограничения | Раздел 1.1 |
| Предметная область, раздел 3 (Actors) | Количество ролей, команд | Раздел 2.1, 2.2 |
| Предметная область, раздел 4 (Entities) | Количество сущностей, сложность | Раздел 2.2 |
| Предметная область, раздел 5 (UC) | Количество сценариев | Раздел 2.1 |
| Предметная область, раздел 7 (Boundaries) | Интеграции, внешние системы | Раздел 2.2 |
| Предметная область, раздел 8 (NFR) | Нагрузка, доступность | Разделы 2.2, 6 |

---

## 1. Обоснуй выбор направления

На этапе предварительного исследования рассматриваются варианты реализации: **платформа**, **архитектурный стиль**, **интеграции**, **хранилища**, **языки/стек**, **наблюдаемость/DevOps**.
Цель — зафиксировать **рациональный выбор** на основании сравнения вариантов и ограничений из предметной области.

### 1.1 Критерии выбора (из предметной области)

| Критерий | Приоритет (H/M/L) | Как проверяем/подтверждаем | Примечание |
|---|---|---|---|
| Надёжность/доступность | <H/M/L> | <SLA/SLO, отказовые сценарии> | <...> |
| Производительность | <H/M/L> | <p95/p99, throughput> | <...> |
| Безопасность | <H/M/L> | <модель угроз, требования> | <...> |
| Интеграции/совместимость | <H/M/L> | <контракты, протоколы> | <...> |
| Эксплуатация | <H/M/L> | <мониторинг, алерты, runbooks> | <...> |
| Стоимость владения (TCO) | <H/M/L> | <infra+ops+лицензии> | <...> |
| Экспертиза команды | <H/M/L> | <skill matrix> | <...> |
| Масштабируемость | <H/M/L> | <горизонтальный рост/лимиты> | <...> |
| Вендор-локин | <H/M/L> | <портируемость/standards> | <...> |

### 1.2 Стандарт документации

| Вариант | Применяется | Обоснование |
|---------|-------------|-------------|
| ГОСТ 19 (ЕСПД) | да/нет | <для ПО общего назначения> |
| ГОСТ 34 (АС) | да/нет | <для автоматизированных систем> |
| Внутренний стандарт | да/нет | <описать> |
| Без стандарта | да/нет | <для небольших проектов> |

**Выбранный стандарт:** <ГОСТ 19 / ГОСТ 34 / внутренний / без стандарта>

**Считать верным:**
```
| ГОСТ 19 (ЕСПД) | нет | Проект не является ПО общего назначения |
| ГОСТ 34 (АС) | да | Заказчик — госструктура, требуется формальная приёмка по ГОСТ 34 |
| Внутренний стандарт | нет | Нет внутреннего стандарта |

**Выбранный стандарт:** ГОСТ 34
```

**Считать неверным:**
```
**Стандарт:** ГОСТ 34
```
Почему: нет таблицы сравнения, нет обоснования почему ГОСТ 34.

### 1.3 Формат диаграмм

| Формат | Применяется | Где используется | Обоснование |
|--------|-------------|------------------|-------------|
| PlantUML | да/нет | ArchiMate, Sequence, Activity, Context Map | <...> |
| Mermaid | да/нет | Flowchart, Sequence, ER | <...> |
| Draw.io / Excalidraw | да/нет | Свободные схемы | <...> |

**Выбранный формат:** <plantuml / mermaid / смешанный>

> **Примечание:** выбор формата влияет на шаблоны диаграмм в:
> - `.requirements/архитектура/диаграммы ArchiMate.md`
> - `.requirements/сценарии/диаграммы сценариев.md`
> - `.requirements/сценарии/диаграммы Context Map.md`

---

## 2. Обоснуй выбор платформы

### 2.1 Рассмотренные варианты

| Вариант | Плюсы | Минусы | Риски/ограничения | Итог |
|---|---|---|---|---|
| On-prem (VM/Bare metal) | <...> | <...> | <...> | <выбран/не выбран/отложено> |
| Cloud (IaaS/PaaS) | <...> | <...> | <...> | <...> |
| Hybrid | <...> | <...> | <...> | <...> |
| Edge/Embedded (если применимо) | <...> | <...> | <...> | <...> |

### 2.2 Принятое решение

**Выбрано:** <PLATFORM_DECISION>
**Основные причины выбора:**
- <причина 1>
- <причина 2>
- <причина 3>

**Границы решения (что входит / что не входит):**
- Входит: <...>
- Не входит / отложено: <...>

---

## 3. Обоснуй архитектурный подход

### 3.1 Масштаб системы

| Масштаб | Характеристики | Типичные решения |
|---------|----------------|------------------|
| **Малая** | 1-3 разработчика, 1 домен, < 10 UC, < 1000 RPS | Монолит, Layered, минимум документации |
| **Средняя** | 3-10 разработчиков, 2-5 доменов, 10-50 UC, 1K-10K RPS | Модульный монолит, DDD light, полная документация |
| **Крупная** | 10+ разработчиков, 5+ доменов, 50+ UC, 10K+ RPS | Микросервисы/EDA, DDD full, строгие контракты |

**Выбранный масштаб:** <малая/средняя/крупная>

**Обоснование:**
- Команда: <размер>
- Домены: <количество>
- Нагрузка: <ожидаемая>
- Срок жизни системы: <1-3 года / 3-5 лет / 5+ лет>

### 3.2 Драйверы архитектурного решения

> Оценить перед выбором стиля. Высокая оценка = сложность, требующая соответствующего решения.

| Драйвер | Оценка (L/M/H) | Описание ситуации | Влияние на выбор |
|---------|----------------|-------------------|------------------|
| **Разделение ответственности** | <L/M/H> | <сколько команд, независимость деплоя> | <монолит/модули/микросервисы> |
| **Масштабируемость** | <L/M/H> | <нагрузка, рост, горячие точки> | <горизонтальное/вертикальное> |
| **Отказоустойчивость** | <L/M/H> | <допустимый downtime, SLA> | <резервирование, graceful degradation> |
| **Доменная сложность** | <L/M/H> | <количество BC, инварианты, правила> | <DDD да/нет, глубина моделирования> |
| **Интенсивность взаимодействия** | <L/M/H> | <sync/async, частота, объем> | <API/Events/Hybrid> |

**Вывод по драйверам:**
- Если большинство L -> простая архитектура (монолит, layered)
- Если M/H в "Разделение" и "Масштабируемость" -> модульная/микросервисная
- Если H в "Доменная сложность" -> DDD обязателен
- Если H в "Взаимодействие" -> event-driven или hybrid

**Считать верным:**
```
| Разделение ответственности | M | 2 команды, независимый деплой желателен | Модульный монолит |
| Масштабируемость | L | < 1000 RPS, рост не ожидается | Вертикальное масштабирование |
| Доменная сложность | H | 5 доменов, сложные инварианты | DDD обязателен |
```

**Считать неверным:**
```
**Архитектура:** микросервисы
```
Почему: нет оценки драйверов, нет обоснования выбора.

### 3.3 Рассмотренные варианты

> **Справочник:** https://github.com/Druk83/arch-patterns — детальное описание архитектурных стилей.

| Вариант | Когда подходит | Сильные стороны | Слабые стороны | Риски | Итог |
|---|---|---|---|---|---|
| Монолит | <...> | <...> | <...> | <...> | <...> |
| Модульная архитектура (слои/модули) | <...> | <...> | <...> | <...> | <...> |
| Микросервисы | <...> | <...> | <...> | <...> | <...> |
| Event-driven (EDA) | <...> | <...> | <...> | <...> | <...> |
| Serverless/Functions | <...> | <...> | <...> | <...> | <...> |

### 3.4 Принятое решение

**Выбрано:** <ARCH_DECISION>
**Почему:**
- <...>
- <...>

**Принципы и ограничения:**
- <например: единые контракты, изоляция модулей, запрет циклических зависимостей, границы контекстов и т.п.>

### 3.5 Методология моделирования и паттерны

> **Важно:** Выбор нотаций и методологий определяет какие подходы из `.approach/` используются на этапах [4]-[7].
> НЕ используй подход, который не был выбран на этапе [2].

#### 3.5.1 Нотации моделирования

**Как визуализируем систему (диаграммы, схемы):**

| Нотация | Основное применение | Инструменты | Этапы SDD |
|---------|---------------------|-------------|-----------|
| UML | Структура ПО (классы, компоненты), поведение (sequence, state) | PlantUML, Enterprise Architect | [5.4], [7.1] |
| BPMN | Бизнес-процессы, workflow, события и шлюзы | Camunda, BPMN.io, PlantUML | [5.1], [5.2] |
| ArchiMate | Enterprise-архитектура: Business/Application/Technology | PlantUML, Archi | [7 BL/AL/TL], [7.1] |

**Правило выбора нотации:**
- UML — для детализации структуры кода и взаимодействий компонентов
- BPMN — для моделирования бизнес-процессов с ветвлениями и событиями
- ArchiMate — **обязательно** для описания слоев архитектуры на этапе [7]

**Связь с инструментами:**
- Формат рендеринга выбран в разделе 1.3 (PlantUML / Mermaid)
- ArchiMate всегда использует `.approach/archimate.md`

#### 3.5.2 Методологии проектирования домена

**Как думаем о доменах, событиях и состояниях:**

| Методология | Применяется | Подход (.approach/) | Влияет на этапы | Когда применять |
|-------------|-------------|---------------------|-----------------|-----------------|
| DDD (Domain-Driven Design) | да/нет | `ddd-patterns.md` | [4], [5.3] | Сложный домен с 3+ bounded contexts |
| Event Storming | да/нет | `event-storming.md` | [5.1], [5.2] | Много асинхронных событий и команд |
| Context Mapping | да/нет | `context-map.md` | [5.3], [5.4] | Интеграция между контекстами/системами |
| MDD (Model-Driven Development) | да/нет | — | [4], [7] | Генерация кода из моделей (редко) |
| Data-Centric (без DDD) | да/нет | — | [4], [6] | Простой CRUD без сложной логики |

**Правило выбора:**
- "Доменная сложность" = H (раздел 3.2) -> DDD + Event Storming + Context Mapping
- "Доменная сложность" = M -> Event Storming + Context Mapping (без DDD)
- "Доменная сложность" = L -> Data-Centric
- MDD — только если есть инструменты генерации и команда владеет подходом

#### 3.5.3 Паттерны потоков данных

**Как организуем чтение/запись и события:**

| Паттерн | Применяется | Влияет на этапы | Когда применять |
|---------|-------------|-----------------|-----------------|
| CQRS | да/нет | [6], [7] | Нагрузка > 10K RPS или явное разделение read/write |
| Event Sourcing | да/нет | [6] | Аудит всех изменений, восстановление состояния |
| Pub/Sub | да/нет | [5.2], [7] | Слабая связанность между модулями |

**Считать верным:**
```
| DDD | да | ddd-patterns.md | Сложная предметная область с 5+ доменами |
| Event Storming | да | event-storming.md | Много асинхронных взаимодействий |
| Context Mapping | да | context-map.md | Интеграция с 3 внешними системами |
| CQRS | нет | — | Нагрузка < 1000 RPS |
```

**Считать неверным:**
```
**Методология:** DDD
```
Почему: нет таблицы, нет связи с подходами, нет обоснования.

#### 3.5.4 Архитектурные паттерны (уровень слоёв приложения)

**Как организуем приложение внутри, границы между слоями:**

> **Справочник:** https://github.com/Druk83/arch-patterns — полный каталог архитектурных паттернов.
> Изучи справочник и выбери оптимальный паттерн для проекта.

| Паттерн | Применяется | Обоснование | Влияет на этапы |
|---------|-------------|-------------|-----------------|
| <паттерн из arch-patterns> | да/нет | <почему подходит/не подходит> | [7], [8] |
| <другой паттерн> | да/нет | <...> | [7], [8] |
| <...> | да/нет | <...> | <...> |

**Алгоритм выбора:**
1. Изучить https://github.com/Druk83/arch-patterns
2. Оценить драйверы из раздела 3.2
3. Выбрать паттерн, соответствующий драйверам и масштабу системы
4. Согласовать выбор с разработчиком

**Типичные комбинации (не ограничивающие):**
- Высокая доменная сложность -> паттерны с изоляцией домена (Hexagonal, Clean, Onion)
- Низкая сложность -> простые паттерны (Layered, MVC)
- Event-driven системы -> паттерны с поддержкой событий (CQRS, Event Sourcing)

#### 3.5.5 Паттерны проектирования (уровень кода)

**Как решаем задачи в конкретном коде:**

| Паттерн | Где применяется | Назначение |
|---------|-----------------|------------|
| Repository | доступ к данным | абстракция хранилища, независимость от БД |
| Factory | создание объектов | инкапсуляция логики создания |
| Strategy | бизнес-логика | сменяемые алгоритмы в runtime |
| Observer/Pub-Sub | события | слабая связанность компонентов |
| Dependency Injection | конструкторы, конфиг | управление зависимостями |

#### 3.5.6 Итог выбора (ОБЯЗАТЕЛЬНО заполнить)

> **Критично:** Этот раздел определяет подходы для этапов [4]-[7].
> Без заполнения переход к этапу [3] запрещен.

**Выбранные нотации (3.5.1):**

| Нотация | Используется | Этапы | Обоснование |
|---------|--------------|-------|-------------|
| UML | да/нет | [5.4], [7.1] | <для чего используем> |
| BPMN | да/нет | [5.1], [5.2] | <для чего используем> |
| ArchiMate | **да (обязательно)** | [7 BL/AL/TL], [7.1] | Описание слоев архитектуры |

**Выбранные методологии проектирования (3.5.2):**

| Методология | Выбрана | Подход (.approach/) | Этапы |
|-------------|---------|---------------------|-------|
| <методология 1> | да/нет | <файл или —> | <этапы> |
| <методология 2> | да/нет | <файл или —> | <этапы> |

**Паттерны потоков данных (3.5.3):**

| Паттерн | Применяется | Этапы | Обоснование |
|---------|-------------|-------|-------------|
| CQRS | да/нет | [6], [7] | <...> |
| Event Sourcing | да/нет | [6] | <...> |

**Выбранный архитектурный паттерн (3.5.4):**

| Паттерн | Источник | Этапы |
|---------|----------|-------|
| <паттерн из arch-patterns> | https://github.com/Druk83/arch-patterns | [7], [8] |

**Обоснование выбора:**
- <почему выбраны именно эти нотации, методологии и паттерн>
- <связь с драйверами из раздела 3.2>

---

## 4. Определи ключевые компоненты

> Это "каркас": компоненты + технологии + статус. Детализация будет в архитектурном документе.

| Компонент | Технология/протокол (предварительно) | Статус (Обяз/Опц/Отложено) | Обоснование |
|---|---|---|---|
| API / Gateway | <...> | <...> | <...> |
| Auth / IAM | <...> | <...> | <...> |
| Основное хранилище | <...> | <...> | <...> |
| Очереди/события | <...> | <...> | <...> |
| Поиск (если нужен) | <...> | <...> | <...> |
| Файлы/артефакты | <...> | <...> | <...> |
| Наблюдаемость | <...> | <...> | <...> |
| CI/CD | <...> | <...> | <...> |
| UI/Клиенты | <...> | <...> | <...> |

---

## 5. Выбери технологический стек

### 5.1 Языки программирования и назначение

| Уровень системы | Основные технологии | Назначение/роль | Примечание |
|---|---|---|---|
| Backend / API | <...> | <...> | <...> |
| Интеграции | <...> | <...> | <...> |
| Data processing (если есть) | <...> | <...> | <...> |
| Frontend / UI | <...> | <...> | <...> |
| DevOps / IaC | <...> | <...> | <...> |

### 5.2 Хранилища и данные

| Назначение | Система | Обоснование | Альтернативы |
|---|---|---|---|
| Транзакционные данные | <...> | <...> | <...> |
| Кэш / очереди | <...> | <...> | <...> |
| Поиск | <...> | <...> | <...> |
| Объектное/файловое хранилище | <...> | <...> | <...> |

### 5.3 Интеграция и обмен данными

| Тип интеграции | Вариант | Где применяется | Почему выбран |
|---|---|---|---|
| Синхронная | REST/gRPC | <...> | <...> |
| Асинхронная | broker/events | <...> | <...> |
| Входящие вызовы | webhooks | <...> | <...> |
| Пакетная | ETL/Batch | <...> | <...> |

---

## 6. Определи NFR показатели

> **Связь с 1.1:** детализируем критерии из предметной области в конкретные, измеримые показатели для выбранной архитектуры.

| Категория | Целевое значение | Как обеспечиваем (направление) |
|---|---|---|
| Надёжность | <...> | <...> |
| Производительность | <...> | <...> |
| Безопасность | <...> | <...> |
| Масштабируемость | <...> | <...> |
| Поддерживаемость | <...> | <...> |
| Наблюдаемость | <...> | <...> |

---

## 7. Зафиксируй требования эксплуатации

1. <backup/restore требования>
2. <RPO/RTO>
3. <security access (MFA/RBAC/audit)>
4. <retention/logging/архивирование>
5. <совместимость/миграции/обновления>

---

## 8. Выяви риски и открытые вопросы

### 8.1 Риски

| Риск | Проявление | Вероятность (L/M/H) | Влияние (L/M/H) | Компенсация |
|---|---|---|---|---|
| <...> | <...> | <...> | <...> | <...> |

### 8.2 Открытые вопросы

| Вопрос | Почему важно | Как закрываем (PoC/интервью/расчёт) | Дедлайн | Владелец |
|---|---|---|---|---|
| <...> | <...> | <...> | <YYYY-MM-DD> | <...> |

---

## 9. Сформулируй вывод

Принято решение использовать: **<platform> + <architecture> + <integration> + <data layer> + <languages/stack>**.

**Выбор обусловлен:**
- Оценкой драйверов из раздела 3.2 (особенно: <драйвер 1: L/M/H>, <драйвер 2>)
- Требованиями предметной области (раздел 1.1): <3-6 буллетов причин>
- Масштабом системы (раздел 3.1): <малая/средняя/крупная>

**Открытые вопросы/PoC:**
- <1-3 пункта с ссылкой на раздел 8.2>

**Следующий шаг:** подготовка документов по архитектуре и стеку на основании выбранного направления.

---

## Критерии готовности этапа [2]

> **Обязательно:** проверь этот чеклист перед переходом к этапу [3].

### Минимальные критерии (блокируют переход)

- [ ] **Стандарт документации:** выбран (ГОСТ 19 / ГОСТ 34 / внутренний / без стандарта) (раздел 1.2)
- [ ] **Формат диаграмм:** выбран (PlantUML / Mermaid / смешанный) (раздел 1.3)
- [ ] **Нотации моделирования:** выбраны (UML/BPMN + ArchiMate обязательно) (раздел 3.5.1)
- [ ] **Методология проектирования:** выбрана >= 1 с указанием подхода из `.approach/` (раздел 3.5.2)
- [ ] **Архитектурный паттерн:** выбран >= 1 из arch-patterns (раздел 3.5.4)
- [ ] **Итог выбора заполнен:** раздел 3.5.6 содержит заполненные таблицы (раздел 3.5.6)
- [ ] **Масштаб системы:** определён (малая / средняя / крупная) (раздел 3.1)
- [ ] **Технологический стек:** определён базовый набор (раздел 5)

### Рекомендуемые критерии (желательны)

- [ ] **Платформа:** выбрана с обоснованием (раздел 2)
- [ ] **Архитектурный стиль:** выбран с обоснованием (раздел 3.3-3.4)
- [ ] **Критерии выбора:** заполнены с приоритетами H/M/L (раздел 1.1)
- [ ] **Драйверы архитектуры:** оценены (раздел 3.2)
- [ ] **Риски:** >= 1 риск с компенсацией (раздел 8.1)
- [ ] **Открытые вопросы:** зафиксированы с дедлайнами (раздел 8.2)

### Gap Tracking и Placeholder'ы

- [ ] **gap-tracking.md ОБЯЗАТЕЛЬНО обновлён:** превентивная проверка выполнена (пустая таблица = валидный результат)
- [ ] **Все пробелы зафиксированы:** с приоритетами HIGH/MEDIUM/LOW и планом закрытия
- [ ] **GAP зафиксированы:** для каждого HIGH/MEDIUM пробела создан GAP в `docs/requirements/gap-tracking.md`
- [ ] **Placeholder'ы с маркерами:** все `<placeholder>` помечены `<!-- @update-after:[N] -->`

### Подпись готовности

| Критерий | Факт | Статус |
|----------|------|--------|
| Стандарт документации выбран | <стандарт> | OK / NOT OK |
| Формат диаграмм выбран | <формат> | OK / NOT OK |
| Методология >= 1 | <методология> | OK / NOT OK |
| Арх. паттерн >= 1 | <паттерн> | OK / NOT OK |
| Масштаб определён | <масштаб> | OK / NOT OK |
| Стек определён | да / нет | OK / NOT OK |

**Дата проверки:** <YYYY-MM-DD>
**Проверил:** <agent/person>
