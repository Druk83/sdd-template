# Описание БД / структура данных — `<PROJECT_NAME>`

> **Важно:** этот файл в `.requirements/**` — **методика** (read-only).
> Финальная спецификация создается в `docs/requirements/структура Данных/описание БД.md`.

---

## 0. Назначение

Единый документ для разработки и ревью структуры данных:

* что хранится (объекты данных),
* как связано (ссылки/зависимости/кардинальности),
* как обеспечивается целостность и производительность (ограничения/индексы/правила валидации),
* на что опираемся (требования/обоснования из `docs/**`, проверка по коду/артефактам).

### Связанные методики

* Правила проектирования: `.requirements/структура Данных/правила проектирования данных.md`
* Шаблоны карточек объектов: `.requirements/структура Данных/шаблоны карточек.md`

---

## 1. Область применения и источники

### 1.1 Источники требований и решений (только `docs/**`)

В этом документе **все** ссылки на требования/сценарии/решения **обязаны** вести в `docs/**`.

Если `docs/` отсутствует:
* зафиксировать GAP в `docs/requirements/gap-tracking.md` на публикацию финальных версий в `docs/`;

Перечислить фактические папки проекта:
* `docs/requirements/обоснование выбора.md`
* `docs/requirements/предметная область.md`
* `docs/requirements/требования/**`
* `docs/requirements/домены/**`
* `docs/requirements/сценарии/**`

### 1.2 Источники проверки (код/артефакты)

Перечислить фактический источник структуры данных (проверка "как реализовано"):
* миграции: `<path>`
* модели/схемы ORM/ODM: `<path>`
* DDL/schema: `<path>`
* генерация схемы/дамп: `<command|path>` (если применимо)
* правила валидации NoSQL: `<path>` (если применимо)
* декларации индексов: `<path>` (если отдельно)

---

## 2. Методология описания

### 2.1 Универсальный принцип (MUST)

Шаблон не фиксирует стек и не предполагает типовые требования.
Единственный источник правил проектирования — `docs/**/обоснование выбора.md` + требования/сценарии `docs/**`.

Документ обязан:
- описывать данные через объекты хранения, выбранные проектом,
- фиксировать контракты структуры и ссылки на источники,
- быть проверяемым по артефактам реализации.

### 2.2 Выбор модели представления

Перед заполнением структуры **зафиксировать** модель представления (на основании `docs/**/обоснование выбора.md`).

| Модель | Единица описания | Детальные файлы |
|--------|------------------|-----------------|
| relational | table/view | `tables/<object>.md` |
| document | collection | `collections/<object>.md` |
| time-series | series/measurement | `series/<object>.md` |
| kv | namespace | `kv/<namespace>.md` |
| graph | node/edge type | `graph/<model>.md` |
| object-storage | bucket/object | `object_storage/<bucket>.md` |
| event-log/stream | topic/stream | `streams/<topic>.md` |
| hybrid | карта хранилищ | по каждому типу |

Заполнить:
- `модель(и): <...>`
- `единица описания: <...>`
- `основание: <docs/**/обоснование выбора.md#...>`

Если `docs/**/обоснование выбора.md` отсутствует — создать задачу в `.tasks/`.

### 2.3 Обязательные срезы описания

Независимо от типа хранилища документ обязан содержать:

1. **Перечень объектов данных** (что хранится и где).
2. **Контракты структуры** (поля/типы/схемы/валидаторы/ограничения).
3. **Связи/зависимости** (FK/ссылки/relations/edge types/ключевые зависимости).
4. **Индексация/ключи доступа** (индексы/ключи/партиции/шардинг — если применимо).
5. **Жизненный цикл данных** (retention/TTL/архив/удаление — если задано требованиями).
6. **Проверяемость** (по каким артефактам подтверждается актуальность).

### 2.4 Формат диаграмм (MUST)

Формат диаграмм задается `docs/**/обоснование выбора.md`:
- `diagram_format: mermaid` -> использовать Mermaid (`.mmd`)
- `diagram_format: plantuml` -> использовать PlantUML (`.plantuml`)

Заполнить:
- `формат диаграмм: <mermaid|plantuml>`
- `основание: <docs/**/обоснование выбора.md#...>`

Если формат не задан — выбрать один и создать задачу `.tasks/<id>` на фиксацию в `docs/**/обоснование выбора.md`.

### 2.5 Типовые диаграммы по модели хранения

| Модель | Тип диаграммы | Что показывать |
|--------|---------------|----------------|
| relational | ERD | таблицы, PK/FK, кардинальности, ключевые индексы |
| document | UML Class Diagram | коллекции, shape документа, связи embedded/reference |
| time-series | UML Component | источники -> raw -> агрегаты, retention, партиции |
| kv | UML Component | namespaces, шаблоны ключей, TTL, зависимости сервисов |
| graph | UML Class Diagram | node/edge types, свойства, constraints, traversal-паттерны |
| object-storage | UML Component | buckets, схема ключей, lifecycle, метаданные |
| event-log/stream | UML Component | topics, producers/consumers, партиционирование, retention |
| hybrid | Component (карта) + типовые по каждому типу | Store ID, потоки данных, SoT |

**Обязательные диаграммы:**
- Базовая (всегда): `diagram.mmd` или `diagram.plantuml`
- Для relational: дополнительно `tables/erd.dbml` (dbdiagram.io)

### 2.6 Правила проектирования по умолчанию

См. `.requirements/структура Данных/правила проектирования данных.md`

---

## 2.7 Процедура заполнения (подтверждение модели данных)

> **ОБЯЗАТЕЛЬНО:** Перед созданием детальных карточек объектов сформулируй модель хранения и перечень объектов, затем получи подтверждение разработчика.

### Почему это важно

Этап [6] определяет структуру данных на основе агрегатов из сценариев [5]:
- Модель хранения (relational/document/kv/etc.) влияет на все карточки объектов
- Перечень объектов определяет объем работы и связи между таблицами/коллекциями
- Ошибка в модели требует переделки всех карточек

### Алгоритм

1. Проанализируй `docs/requirements/сценарии/<domain>/` (агрегаты, события)
2. Извлеки модель хранения из `docs/requirements/обоснование выбора.md`
3. Сформулируй перечень объектов данных на основе агрегатов
4. Выведи блок "КАНДИДАТЫ ОБЪЕКТОВ ДАННЫХ — ТРЕБУЕТСЯ ПОДТВЕРЖДЕНИЕ"
5. Дождись подтверждения или корректировки от разработчика
6. После подтверждения — создай детальные карточки объектов

### Формат блока подтверждения

> **ВНИМАНИЕ:** Формат ниже — это **структура**, а не готовый пример для копирования.
> Заполни placeholder'ы (`<...>`) реальными данными из `docs/requirements/сценарии/`.

```
КАНДИДАТЫ ОБЪЕКТОВ ДАННЫХ — ТРЕБУЕТСЯ ПОДТВЕРЖДЕНИЕ

На основе анализа сценариев и агрегатов предлагается модель данных:

1. МОДЕЛЬ ХРАНЕНИЯ
   Выбрана: <модель из docs/requirements/обоснование выбора.md>
   Технология: <технология из обоснования выбора>
   Основание: <ссылка на раздел обоснования>

2. КАРТА ХРАНИЛИЩ (если hybrid или несколько хранилищ)
   | Store ID | Тип | Назначение |
   |----------|-----|------------|
   | <id> | <тип> | <назначение из проекта> |

3. ПЕРЕЧЕНЬ ОБЪЕКТОВ ДАННЫХ
   На основе агрегатов из docs/requirements/сценарии/<domain>/:

   | Объект | Тип | Агрегат-источник | Домен |
   |--------|-----|------------------|-------|
   | <имя_объекта> | <table/collection/kv> | <имя агрегата из BC> | <домен из реестра> |

4. КЛЮЧЕВЫЕ СВЯЗИ
   - <объект_A> <кардинальность> <объект_B> (<тип связи>)

Пожалуйста, подтвердите перечень объектов или укажите корректировки.
После подтверждения будут созданы детальные карточки для каждого объекта.
```

### Правила формирования кандидатов

> Извлекай данные **только** из документации проекта, а не из примеров шаблона.

| Источник | Что извлекать | Куда маппить |
|----------|---------------|--------------|
| `docs/requirements/сценарии/<domain>/ограниченные контексты.md` | Root aggregate из раздела "Агрегаты" | Основная таблица/коллекция |
| Тот же файл | Child entities внутри агрегата | Связанные таблицы или embedded |
| Тот же файл | Value Objects (если выделены) | Отдельная таблица или JSON-поле |
| `docs/requirements/сценарии/<domain>/каталог мероприятий.md` | События с payload | Event store или audit log |
| `docs/requirements/обоснование выбора.md` | CQRS (если выбран) | Отдельные read model таблицы |

### Важно

- Формат блока — это **структура для заполнения**, не готовый пример
- **Запрещено** копировать примеры из шаблонов — только извлекай из проекта
- Все имена объектов, агрегатов и доменов берутся из `docs/requirements/`
- Если агрегаты не определены в сценариях — создай GAP и запроси уточнение
- Если модель хранения не выбрана в обосновании — создай GAP

---

## 3. Ожидаемый результат (выходные артефакты)

Финальные артефакты публикуются в `docs/requirements/структура Данных/**`.

### 3.1 Минимум (обязателен)

1. `описание БД.md` — финальная спецификация (обзор, перечень объектов, ссылки, диаграммы)
2. Детальные спецификации объектов: `<type-dir>/<object>.md` (по шаблону из `.requirements/структура Данных/шаблоны карточек.md`)
3. Диаграммы:
   - `diagram.mmd` или `diagram.plantuml` (обязательно одно)
   - `tables/erd.dbml` (если есть relational)

### 3.2 Дополнительно

4. `validation-report.md` — если есть расхождения требования vs код/миграции/схема

---

## 4. Структура финальной спецификации

### 4.1 Общая информация

* модель(и) хранилища: `<...>`
* единица описания: `<...>`
* технология/версия (если известно): `<...>`
* имя БД / схемы / неймспейсы: `<...>`
* назначение: `<1-2 строки>`
* формат диаграмм: `<mermaid|plantuml>`
* основание выбора: `<docs/**/обоснование выбора.md#... | draft:.requirements/... + .tasks/<id>>`
* источники требований: список ссылок на `docs/**`
* источники проверки: пути к миграциям/моделям/DDL/валидациям

### 4.2 Карта хранилищ (если несколько или hybrid)

| Store ID | Тип | Назначение | Владелец (сервис/модуль) | Источники `docs/**` | Источники проверки |
|---|---|---|---|---|---|
| DB-01 | relational | ... | ... | ... | ... |

### 4.3 Перечень объектов данных

| Объект | Тип | Где хранится (Store ID) | Файл спецификации | Источники `docs/**` |
|---|---|---|---|---|
| `users` | table | DB-01 | `tables/users.md` | `docs/...` |

### 4.4 Диаграммы

Обязателен один файл:
- `diagram.mmd` или `diagram.plantuml`

Если используется `relational`:
- дополнительно `tables/erd.dbml`

---

## 5. Шаблон детальной спецификации объекта

См. `.requirements/структура Данных/шаблоны карточек.md`

---

## 6. Порядок подготовки и обновления спецификации

1. Зафиксировать модель(и) и основание (раздел 2.2).
2. Указать формат диаграмм (раздел 2.4).
3. Сформировать перечень объектов данных (раздел 4.3).
4. Создать/обновить детальные спецификации объектов (по шаблону).
5. Подготовить обязательные диаграммы.
6. Проставить ссылки на требования/сценарии/обоснование (`docs/**`) и источники проверки (код).
7. Выполнить валидацию (раздел 7).
8. Если обнаружены расхождения — оформить `validation-report.md` и создать `.tasks/<id>`.

---

## 7. Проверка / валидация

Чеклист:

* [ ] перечислены все объекты, упомянутые в `docs/**`
* [ ] для каждого объекта есть детальный файл спецификации
* [ ] связи/зависимости/индексация описаны в форме, соответствующей модели хранения
* [ ] ссылки на требования/решения ведут в `docs/**`
* [ ] источники проверки (код/артефакты) указаны и воспроизводимы
* [ ] присутствует обязательная диаграмма: `diagram.mmd` или `diagram.plantuml`
* [ ] если используется `relational` — присутствует `tables/erd.dbml`
* [ ] диаграммы согласованы с перечнем объектов и карточками
* [ ] расхождения зафиксированы в `validation-report.md` и `.tasks/<id>` (если есть)
* [ ] ревью зафиксировано

---

## 8. Правила ссылок

* Требования/сценарии/обоснования: только `docs/**`.
* Запрещены относительные ссылки: `../`, `./`, а также ссылки без префикса `docs/`.
* Каждая ссылка **должна начинаться** с `docs/`. Пример: `docs/requirements/требования/nfr.md#NFR-PERF-01`.
* Любое существенное решение по структуре должно иметь ссылку на `docs/**` и при необходимости на `.tasks/<id>`.

---

## 9. Организация файлов

Финальные артефакты: `docs/requirements/структура Данных/**`:
* `описание БД.md`
* `diagram.mmd` или `diagram.plantuml`
* для relational: `tables/erd.dbml`
* подпапки по типу: `tables/`, `collections/`, `series/`, `kv/`, `graph/`, `object_storage/`, `streams/`
* `validation-report.md` (при необходимости)

---

## 10. Режим теста

> Используется только если явно указан в задании.

### 10.1 Ограничение состава вывода (MUST)

Если в задании указан "режим теста" и перечислены обязательные артефакты/объекты:
* Вывести **ровно** те документы и карточки, которые перечислены в задании.
* Запрещено добавлять дополнительные объекты/артефакты.
* Разрешено добавить только блок "Открытые вопросы" (не более 5 пунктов).

### 10.2 Специальное правило для KV/Redis в режиме теста (MUST)

Если в задании сказано "KV/Redis без отдельной карточки":
* KV/Redis описывается только в карте хранилищ и кратко в соответствующих местах.
* Запрещено выводить отдельные карточки `kv/**`.

---

## 11. Процедуры этапа [6] (H6)

### 11.1 Зафиксируй модель хранения (H7)
**Что делать:**
- Определи модель хранения из `docs/**/обоснование выбора.md`.
- Зафиксируй единицу описания и основание.

**Считать верным:**
- Указана модель (relational/document/kv/...) и ссылка на `docs/**/обоснование выбора.md`.

**Считать неверным:**
- Модель не указана или взята “по умолчанию” без основания.

### 11.2 Составь перечень объектов данных (H7)
**Что делать:**
- Выведи список объектов из агрегатов сценариев.
- Для каждого объекта укажи тип и Store ID.

**Считать верным:**
- Таблица объектов заполнена и связана с источниками `docs/**`.

**Считать неверным:**
- Перечень объектов не связан со сценариями или отсутствуют источники.

### 11.3 Опиши связи, индексы и жизненный цикл (H7)
**Что делать:**
- Зафиксируй связи/кардинальности.
- Определи индексацию и TTL/retention при наличии требований.

**Считать верным:**
- Есть явные связи и индексы, согласованные с моделью хранения.

**Считать неверным:**
- Нет связей/индексов или они противоречат выбранной модели.

---

## 12. Критерии готовности этапа [6]

### Минимальные
- [ ] Модель хранения зафиксирована с основанием из `docs/**`.
- [ ] Перечень объектов данных заполнен и связан с `docs/**`.
- [ ] Для каждого объекта есть детальная карточка.
- [ ] Обязательная диаграмма создана.
- [ ] Ссылки на требования/сценарии ведут в `docs/**`.

### Gap Tracking
- [ ] `gap-tracking.md` ОБЯЗАТЕЛЬНО обновлен (пустая таблица = валидный результат превентивной проверки)
- [ ] Все пробелы зафиксированы с приоритетами (HIGH/MEDIUM/LOW)
