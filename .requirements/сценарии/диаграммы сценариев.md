# Диаграммы сценариев — шаблон построения

> **Важно:** этот файл в `.requirements/**` — **методика** (read-only).
> Определяет правила описания и визуализации сценариев.

---

## 1. Когда строить диаграммы

**Предусловия:**
- Этап [5] Сценарии завершен (карта процесса заполнена)
- Есть минимум 1 UC с последовательностью шагов
- Формат диаграмм зафиксирован в `docs/requirements/обоснование выбора.md`

**Результат:**
- `docs/requirements/сценарии/<domain>/use-cases.md` — текстовые описания
- `docs/requirements/сценарии/<domain>/diagrams/UC-XX.plantuml` — диаграммы

---

## 2. Типы описаний сценариев

| Тип | Назначение | Когда использовать |
|-----|------------|-------------------|
| **Use Case по актору** | Что актор может делать в системе | Обзор функций для роли |
| **Sequence сценарий** | Взаимодействие компонентов во времени | Детализация UC, интеграции |
| **Use Case Diagram** | Визуализация связей актор-UC | Обзор системы |
| **Sequence Diagram** | Визуализация потока сообщений | Детализация взаимодействий |

---

## 3. Use Case по актору (текстовый формат)

### 3.1 Шаблон

```markdown
## N. Диаграмма вариантов использования «<Актор>»

**Актор:** <Имя актора>
**Цель:** <что актор хочет достичь>

### Основной поток событий

1. <Актор> <действие>.
2. Выполняет **<действие>** (`<<include>> <SubUC>`).
3. После входа получает доступ к функциям:
   * **<Функция 1>** (<описание>);
   * **<Функция 2>** (`<<include>> <SubUC>`);
   * **<Функция 3>** (`<<extend>> <ExtUC>`).
4. При <условии> система <реакция>.
5. В случае <события> получает <уведомление>.

### Альтернативные потоки

* <Условие A> → <реакция>.
* <Условие B> → <реакция>.
```

### 3.2 Пример

```markdown
## 1. Диаграмма вариантов использования «Жилец»

**Актор:** Жилец (Resident)
**Цель:** управление устройствами и сценариями своей квартиры.

### Основной поток событий

1. Жилец открывает мобильное приложение или PWA.
2. Выполняет **авторизацию** в системе (`<<include>> Авторизация`).
3. После входа получает доступ к функциям:
   * **Просмотреть состояние квартиры** (температура, влажность);
   * **Запустить сценарий** («Я дома», «Я вышел»);
   * **Управлять устройствами** (`<<include>> Управление оборудованием`);
   * **Просмотреть уведомления** (`<<include>> Получение уведомления`).
4. При активации сценария система передаёт команды в IoT Gateway.
5. В случае тревоги получает push/SMS уведомление (`<<extend>> Реакция на аварию`).

### Альтернативные потоки

* Ошибка авторизации → сообщение о неверных данных.
* Устройство недоступно → статус *offline*, предложена диагностика.
```

---

## 4. Sequence сценарий (текстовый формат)

### 4.1 Шаблон

```markdown
## Сценарий N. <Название>

**Цель:**
<Что демонстрирует сценарий>

**Участники:**
<Actor>, <Service1>, <Service2>, <Database>.

**Последовательность событий:**

1. <Actor> <действие>.
2. <Component1> <действие> в **<Component2>** (`/api/endpoint`).
3. **<Component2>**:
   3.1. <Подшаг 1>.
   3.2. <Подшаг 2>.
   3.3. <Подшаг 3>.
4. <Component2> возвращает <результат> в <Component1>.
5. При <условии>:
   * <действие A>;
   * <действие B>.
6. Все изменения фиксируются в Audit Log.

**Результат:**
<Итог сценария, что достигнуто>
```

### 4.2 Пример

```markdown
## Сценарий 1. Авторизация пользователя

**Цель:**
Процесс входа жильца в систему с проверкой учётных данных и выдачей токена.

**Участники:**
Жилец, API Gateway, Auth & IAM Service, PostgreSQL, Redis.

**Последовательность событий:**

1. Пользователь открывает приложение и вводит логин и пароль.
2. API Gateway пересылает запрос в **Auth & IAM Service** (`/auth/login`).
3. **Auth Service**:
   3.1. Проверяет пользователя в **PostgreSQL**.
   3.2. Если найден и активен — генерирует `access_token` и `refresh_token`.
   3.3. Сохраняет `refresh_token` в **Redis** (AOF).
4. Возвращает токены в API Gateway → клиенту.
5. Клиент сохраняет `access_token` в sessionStorage.

**Результат:**
Пользователь успешно авторизован, получены токены для работы с системой.
```

---

## 5. Сводная таблица сценариев

### 5.1 Шаблон

```markdown
| Актор | Основные сценарии | Включения / Расширения |
|-------|-------------------|------------------------|
| **<Актор1>** | <UC1>, <UC2>, <UC3> | `<<include>>` X, `<<extend>>` Y |
| **<Актор2>** | <UC4>, <UC5> | `<<include>>` Z |
```

### 5.2 Пример

```markdown
| Актор | Основные сценарии | Включения / Расширения |
|-------|-------------------|------------------------|
| **Жилец** | Авторизация, состояние, сценарии, уведомления | `<<include>>` Авторизация, `<<extend>>` Реакция на аварии |
| **Администратор УК** | Управление пользователями, оборудованием, РСО | `<<include>>` Интеграция РСО, `<<extend>>` Emergency Stop |
| **Диспетчер** | Обработка аварий, взаимодействие с МЧС | `<<include>>` Интеграция экстренных служб |
```

---

## 6. Use Case Diagram — PlantUML

### 6.1 Шаблон

```plantuml
@startuml UC_<Domain>
!theme plain
skinparam backgroundColor #FFFFFF
skinparam actorStyle awesome

title Use Case Diagram: <Domain>

' ========== АКТОРЫ ==========
actor "Жилец" as Resident
actor "Администратор УК" as Admin
actor "Диспетчер" as Dispatcher

' ========== СИСТЕМА ==========
rectangle "Smart Home System" {
    usecase "Авторизация" as UC_Auth
    usecase "Просмотр состояния" as UC_Status
    usecase "Запуск сценария" as UC_Scenario
    usecase "Управление устройствами" as UC_Devices
    usecase "Получение уведомлений" as UC_Notify
    usecase "Обработка аварии" as UC_Emergency
    usecase "Интеграция МЧС" as UC_MES
}

' ========== СВЯЗИ ==========
Resident --> UC_Auth
Resident --> UC_Status
Resident --> UC_Scenario
Resident --> UC_Devices
Resident --> UC_Notify

Admin --> UC_Auth
Admin --> UC_Devices
Admin --> UC_Emergency

Dispatcher --> UC_Emergency
Dispatcher --> UC_MES

' ========== INCLUDE / EXTEND ==========
UC_Status ..> UC_Auth : <<include>>
UC_Scenario ..> UC_Auth : <<include>>
UC_Emergency ..> UC_Notify : <<include>>
UC_Emergency <.. UC_MES : <<extend>>

@enduml
```

---

## 7. Sequence Diagram — PlantUML

### 7.1 Шаблон

```plantuml
@startuml SC_<Number>_<Name>
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title Сценарий N: <Название>

' ========== УЧАСТНИКИ ==========
actor "Жилец" as User
participant "API Gateway" as GW
participant "Auth Service" as Auth
database "PostgreSQL" as DB
database "Redis" as Cache

' ========== ПОСЛЕДОВАТЕЛЬНОСТЬ ==========
User -> GW : POST /auth/login\n{login, password}
activate GW

GW -> Auth : authenticate(credentials)
activate Auth

Auth -> DB : SELECT user WHERE login=?
DB --> Auth : user_record

alt user found AND password valid
    Auth -> Auth : generate tokens
    Auth -> Cache : SET refresh_token
    Cache --> Auth : OK
    Auth --> GW : {access_token, refresh_token}
else invalid credentials
    Auth --> GW : 401 Unauthorized
end

deactivate Auth

GW --> User : {tokens} / error
deactivate GW

@enduml
```

### 7.2 Формат сообщений

```plantuml
' REST запрос
User -> GW : POST /endpoint\n{payload}

' Синхронный вызов
GW -> Service : method(params)

' Ответ
Service --> GW : result

' Условие
alt <condition>
    ...
else <alternative>
    ...
end

' Цикл
loop <condition>
    ...
end

' Опциональный блок
opt <condition>
    ...
end

' Параллельные действия
par
    Service -> DB : query1
else
    Service -> Cache : query2
end
```

---

## 8. Sequence Diagram — Mermaid

### 8.1 Шаблон

```mermaid
sequenceDiagram
    autonumber
    title Сценарий N: <Название>

    actor User as Жилец
    participant GW as API Gateway
    participant Auth as Auth Service
    participant DB as PostgreSQL
    participant Cache as Redis

    User->>GW: POST /auth/login {login, password}
    activate GW

    GW->>Auth: authenticate(credentials)
    activate Auth

    Auth->>DB: SELECT user WHERE login=?
    DB-->>Auth: user_record

    alt user found AND password valid
        Auth->>Auth: generate tokens
        Auth->>Cache: SET refresh_token
        Cache-->>Auth: OK
        Auth-->>GW: {access_token, refresh_token}
    else invalid credentials
        Auth-->>GW: 401 Unauthorized
    end

    deactivate Auth
    GW-->>User: {tokens} / error
    deactivate GW
```

---

## 9. Паттерны из примеров

### 9.1 Подшаги (нумерация)

```markdown
3. **Auth Service**:
   3.1. Проверяет пользователя в **PostgreSQL**.
   3.2. Генерирует токены.
   3.3. Сохраняет в **Redis**.
```

В PlantUML:
```plantuml
Auth -> DB : 1. SELECT user
DB --> Auth : user_record
Auth -> Auth : 2. generate tokens
Auth -> Cache : 3. SET refresh_token
```

### 9.2 Include / Extend

```markdown
* **Управлять устройствами** (`<<include>> Управление оборудованием`);
* В случае тревоги (`<<extend>> Реакция на аварию`).
```

В PlantUML:
```plantuml
UC_Main ..> UC_Sub : <<include>>
UC_Main <.. UC_Ext : <<extend>>
```

### 9.3 Альтернативные потоки

```markdown
### Альтернативные потоки

* Ошибка авторизации → сообщение о неверных данных.
* Устройство недоступно → статус *offline*.
```

В PlantUML:
```plantuml
alt success
    Auth --> GW : tokens
else error
    Auth --> GW : 401 Unauthorized
end
```

### 9.4 Жирные названия компонентов

```markdown
2. API Gateway пересылает запрос в **Auth & IAM Service**.
3. **Auth Service** выполняет проверку.
```

В PlantUML — используй participant с понятными именами:
```plantuml
participant "Auth & IAM Service" as Auth
```

### 9.5 REST endpoints в описании

```markdown
2. API Gateway пересылает запрос (`/auth/login`).
```

В PlantUML:
```plantuml
User -> GW : POST /auth/login
```

---

## 10. Чеклист

### Текстовое описание
- [ ] Указаны **Актор** и **Цель**
- [ ] Основной поток пронумерован (1, 2, 3...)
- [ ] Подшаги имеют вложенную нумерацию (3.1, 3.2...)
- [ ] **Жирным** выделены компоненты системы
- [ ] Указаны `<<include>>` и `<<extend>>` связи
- [ ] Описаны альтернативные потоки
- [ ] Есть **Результат** в конце

### Диаграммы
- [ ] Используется `!theme plain`
- [ ] Участники соответствуют тексту
- [ ] alt/else для альтернативных потоков
- [ ] REST endpoints в сообщениях
- [ ] Диаграмма рендерится без ошибок

---

## 11. Ссылки

- Карта процесса: `.requirements/сценарии/карта процесса.md`
- Примеры: `примеры/3-3-1.сценарии.md`, `примеры/3-3-2.сценарии.md`
- Формат диаграмм: `docs/requirements/обоснование выбора.md`
