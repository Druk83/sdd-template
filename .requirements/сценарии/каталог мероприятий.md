# Каталог мероприятий (Event Catalog)

<!--
> **Важно:** этот файл в `.requirements/**` — **шаблон/каркас** (read-only).
> Заполненная (фактическая) версия для каждого домена хранится в:  
> `docs/requirements/сценарии/<domain_slug>/каталог мероприятий.md` (write-only).
Назначение: единый справочник событий (domain/integration/technical), их контрактов и ответственности.

Рекомендации:
- Имена событий: PastTense, PascalCase (пример: OrderPlaced) или snake_case — но единообразно.
- Версионирование: <EventName>.v1 / schemaVersion: 1
- Указывать владельца (publisher BC) и потребителей (subscriber BC).
Примечание:
- Этот шаблон НЕ должен ссылаться на конкретные проектные файлы (кроме формата путей).
- В заполненной версии (docs) допускаются конкретные ссылки на карту процесса домена и карточку домена. -->

## 0. Контекст документа
- **Проект / продукт:** `<project-name>`
- **Домен (slug):** `<domain_slug>`
- **Дата обновления:** `<YYYY-MM-DD>`
- **Владелец каталога:** `<team/person>`
- **Связанные документы (формат):**
  - Карта процесса домена: `docs/requirements/сценарии/<domain_slug>/карта процесса.md`
  - Карточка домена: `docs/requirements/домены/<domain_slug>.md`

## 1. Конвенции

### 1.1 Классификация событий
- **Domain Event:** факт в домене (важен бизнесу)
- **Integration Event:** событие для межконтекстного взаимодействия
- **Technical Event:** технический сигнал (лог/метрика/инфраструктура) — по возможности отдельно

### 1.2 Общая оболочка события (envelope)
Минимум рекомендуется:
- `eventId` (UUID)
- `eventType`
- `eventVersion`
- `occurredAt` (ISO-8601)
- `correlationId`
- `causationId`
- `producer` (service/BC)
- `payload` (business fields)

### 1.3 Идемпотентность и доставка
- **Delivery:** `<at-least-once|exactly-once|at-most-once>`
- **Idempotency key:** `<eventId|domainId+sequence|...>`

## 2. Реестр событий (таблица)
> Заполни сначала таблицу, потом — подробные карточки для ключевых EVT.

| Event (EVT) | Тип (Domain/Integration/Technical) | Причина (Trigger) | Владелец (Publisher BC) | Потребители (Subscribers) | Payload (минимум) | SLA/критичность | Примечания |
|---|---|---|---|---|---|---|---|
| `<EventName>` | `<type>` | `<cmd/policy/ext>` | `<BC>` | `<BCs>` | `<fields>` | `<P1/P2/P3>` | `<notes>` |
| `<EventName>` | `<type>` |  |  |  |  |  |  |

## 3. Карточки событий (подробно)

### 3.1 EVT: `<EventName>`
- **Тип:** `<Domain|Integration|Technical>`
- **Описание:** `<what fact happened>`
- **Когда публикуется:** `<conditions>`
- **Кто публикует (BC/service):** `<publisher>`
- **Кто потребляет:** `<subscribers + why>`
- **Команда/политика-источник:** `<CMD|POL name>`
- **Связанные события:** `<previous/next>`

#### 3.1.1 Payload (поля)
| Поле | Тип | Обязательность | Описание | Пример |
|---|---|---:|---|---|
| `<field>` | `<type>` | `yes/no` | `<meaning>` | `<example>` |
| `<field>` | `<type>` |  |  |  |

#### 3.1.2 Пример события (JSON)
```json
{
  "eventId": "<uuid>",
  "eventType": "<EventName>",
  "eventVersion": 1,
  "occurredAt": "<ISO-8601>",
  "correlationId": "<id>",
  "causationId": "<id>",
  "producer": "<service-or-bc>",
  "payload": {
    "<field1>": "<value>",
    "<field2>": "<value>"
  }
}
```

### 3.1.3 Семантика и гарантии

* **Идемпотентность:** `<how>` — какой ключ используется (например, `eventId` или `domainId+sequence`).
* **Доставка (delivery):** `<at-least-once|exactly-once|at-most-once>` — ожидаемая семантика.
* **Порядок (ordering):** `<none|per-key|global>` — правила упорядочивания (например, per-key по entityId).
* **Совместимость версий:** `<rules>` — политика backward/forward, использование `eventVersion`/`schemaVersion`.
* **Ошибки и ретраи:** `<policy>` — ретраи, DLQ, обработка “poison messages”.
* **SLA / критичность:** `<P1|P2|P3>` и ожидаемое время реакции/восстановления.
* **Мониторинг и алерты:** метрики (`events.published`, `events.failed`, `events.retries`), пороги, алерты.

#### 3.1.4 Тестирование и контракт

* **Contract tests:** где хранится схема (JSON Schema / Avro / Protobuf), путь к тестам, как запускать (CI job).
* **Golden samples:** `<paths>` — примеры событий для контрактных тестов / интеграции.
* **Валидация:** проверка схемы у производителя и потребителя; тесты на совместимость версий.
* **Contract verification:** требования к CI (PR должен запускать контракт-тесты или проверку схемы).

#### 3.1.5 Метаданные и трассировка

* Рекомендуется включать `correlationId`, `causationId`, `traceparent/traceid` (если есть distributed tracing).
* Логирование: стандартизированные поля (`eventId`, `eventType`, `producer`, `status`).

---

### 3.2 EVT: `<EventName>` (шаблон)

> Скопируйте структуру карточки из раздела **3.1** и заполните поля под конкретное событие.

* **Тип:** `<Domain|Integration|Technical>`
* **Описание:** `<что произошло в домене>`
* **Когда публикуется:** `<условия>`
* **Кто публикует (BC/service):** `<publisher>`
* **Кто потребляет:** `<subscribers + зачем>`
* **Команда / политика-источник:** `<CMD|POL>`
* **Связанные события:** `<previous/next>`

**Payload (минимум):** перечислить поля в таблице (см. 3.1.1)
**Пример события (JSON):** добавить JSON-пример и golden samples в репозиторий.

---

## 4. Статусы и жизненные циклы (опционально)

* **Entity:** `<Order|Document|...>`
* **Статусы:** перечислить (например, `Draft → Submitted → Paid → Shipped → Completed → Cancelled`).

**Пример таблицы переходов:**

| From        | Event              | To          | Комментарий                   |
| ----------- | ------------------ | ----------- | ----------------------------- |
| `Draft`     | `OrderSubmitted`   | `Submitted` | Создание заказа пользователем |
| `Submitted` | `PaymentConfirmed` | `Paid`      | Платёж успешно прошёл         |
| `Paid`      | `ShipmentCreated`  | `Shipped`   | Отправка заказа               |

* Укажите гарантии: какие события окончательные, какие могут компенсироваться, есть ли compensating actions.

---

## 5. Связь с тестированием (опционально)

* **Contract tests:** где и как запускаются (CI, schema registry, consumer-driven contract tests).
* **Golden samples:** путь в репозитории (`/tests/golden/<event-name>.json`) и правила обновления.
* **Integration tests:** энд-то-энд тесты, окружения, тестовые топики/каналы.
* **Monitoring:** метрики на событие, SLOs, алерты (рост `events.failed` или падение throughput).
* **Acceptance criteria:** критерии приёма по контрактам (все потребители проходят contract tests при изменении схемы).
