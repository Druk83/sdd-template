# Создай каталог мероприятий (H6)

Процедура этапа [5.2] из `.requirements/трек разработки.md`.

> **Важно:** это **шаблон** (read-only) в `.requirements/**`.
> Результат создаётся в: `docs/requirements/сценарии/<domain_slug>/каталог мероприятий.md`.

---

**Входные данные:**
- `docs/requirements/сценарии/<domain_slug>/карта процесса.md` (этап [5.1])

**Выходные данные:**
- `docs/requirements/сценарии/<domain_slug>/каталог мероприятий.md` (H8)

---

**Правила формирования:**
- Имена событий: PastTense, PascalCase (OrderPlaced) или snake_case — единообразно
- Версионирование: `<EventName>.v1` / `schemaVersion: 1`
- Указывать владельца (publisher BC) и потребителей (subscriber BC)

---

## Примеры заполнения (ОБЯЗАТЕЛЬНО изучить перед созданием)

> **Важно:** Примеры ниже носят иллюстративный характер. Конкретные события,
> их payload и потребители должны определяться на основе предметной области
> и требований конкретного проекта, а не копироваться из примера.

### Считать верным: Достаточная детализация

**Реестр событий:**

| Event (EVT) | Тип | Причина (Trigger) | Владелец (Publisher BC) | Потребители | Payload (минимум) | SLA | Примечания |
|---|---|---|---|---|---|---|---|
| OrderCreated | Domain | CMD: CreateOrder | Order-BC | Inventory-BC, Notification-BC | orderId, customerId, items[], totalAmount | P1 | Триггерит резервирование |
| ItemsReserved | Domain | CMD: ReserveItems | Inventory-BC | Order-BC | orderId, reservationId, items[], expiresAt | P1 | TTL 30 min |
| OrderConfirmed | Integration | EVT: PaymentCompleted | Order-BC | Fulfillment-BC, Analytics-BC | orderId, confirmedAt, paymentId | P2 | Асинхронно |

**Карточка события:**

```markdown
### EVT: OrderCreated

- **Тип:** Domain
- **Описание:** Заказ создан клиентом и ожидает подтверждения
- **Когда публикуется:** После успешной валидации данных заказа и резервирования товаров
- **Кто публикует (BC/service):** Order-BC
- **Кто потребляет:**
  - Inventory-BC — для подтверждения резерва
  - Notification-BC — для отправки email клиенту
- **Команда/политика-источник:** CMD: CreateOrder
- **Связанные события:** предшествует OrderConfirmed или OrderCancelled

#### Payload (поля)

| Поле | Тип | Обязательность | Описание | Пример |
|---|---|---|---|---|
| orderId | UUID | yes | Уникальный идентификатор заказа | "550e8400-e29b-41d4-a716-446655440000" |
| customerId | UUID | yes | ID клиента | "user-123" |
| items | array | yes | Список товаров | [{productId, quantity, price}] |
| totalAmount | decimal | yes | Сумма заказа | 1500.00 |
| currency | string | yes | Валюта | "RUB" |
| createdAt | ISO-8601 | yes | Время создания | "2026-01-25T10:30:00Z" |

#### Пример события (JSON)

\`\`\`json
{
  "eventId": "evt-789",
  "eventType": "OrderCreated",
  "eventVersion": 1,
  "occurredAt": "2026-01-25T10:30:00Z",
  "correlationId": "order-550e8400",
  "causationId": "cart-123",
  "producer": "order-service",
  "payload": {
    "orderId": "550e8400-e29b-41d4-a716-446655440000",
    "customerId": "user-123",
    "items": [
      {"productId": "prod-1", "quantity": 2, "price": 500.00},
      {"productId": "prod-2", "quantity": 1, "price": 500.00}
    ],
    "totalAmount": 1500.00,
    "currency": "RUB"
  }
}
\`\`\`
```

### Считать неверным: Недостаточная детализация

```markdown
## Каталог мероприятий домена Orders

## Мероприятия (события)
- OrderCreated — заказ создан
- OrderConfirmed — заказ подтверждён

## Минимальный payload
- OrderCreated: orderId, timestamp
- OrderConfirmed: orderId, timestamp

## Пробелы
- Не определены дополнительные события
```

**Почему неверно:**
- Нет реестра в табличном формате
- Нет указания типа события (Domain/Integration/Technical)
- Нет владельца (publisher) и потребителей (subscribers)
- Payload слишком минимальный — нет бизнес-данных
- Нет JSON-примера
- Нет связи с командами (CMD)
- **Невозможно построить контракт** на основе этих данных

---

## Минимальные критерии детализации каталога

| Элемент | Минимум | Как проверить |
|---------|---------|---------------|
| **События в домене** | >= 3 события | Каждый UC порождает минимум 1-2 события |
| **Команды (CMD)** | >= 2 команды | Каждое действие актора = команда |
| **Реестр событий** | Таблица с 7+ колонками | Event, Тип, Trigger, Publisher, Subscribers, Payload, SLA |
| **Карточки событий** | >= 1 детальная карточка на ключевое событие | С payload таблицей и JSON-примером |
| **Payload полей** | >= 4 поля для ключевых событий | Бизнес-данные, не только ID и timestamp |
| **Publisher/Subscriber** | Указаны для каждого события | Кто публикует, кто потребляет |

**Правило:** если каталог не проходит минимум — агент ОБЯЗАН детализировать.

---

## Правила извлечения данных для каталога мероприятий

| Откуда | Что извлекать | Куда |
|--------|---------------|------|
| Карта процесса, последовательность | EVT из шагов | Реестр событий |
| Карта процесса, последовательность | CMD из шагов | Раздел команд (если есть) |
| Карта процесса, идентификаторы | correlationId, поля payload | Карточка события, payload |
| Карта процесса, инварианты (BR) | Правила валидации | Условия публикации события |
| Карточка домена, `interfaces` | Интеграции с другими BC | Тип события (Integration), subscribers |
| Карточка домена, `owned_data` | Сущности | Поля payload |

---

## Процедура заполнения (подтверждение событий)

> **Критически важно:** Агент НЕ создает детальные карточки событий без подтверждения разработчика.

### Шаг 1. Извлечение кандидатов событий

Из карты процесса агент извлекает:
- Все EVT из последовательностей UC
- Все CMD из последовательностей UC
- Publisher/Subscriber для каждого события

### Шаг 2. Формирование блока подтверждения

**Формат блока:**

```
КАНДИДАТЫ СОБЫТИЙ ДЛЯ ДОМЕНА <domain_slug> — ТРЕБУЕТСЯ ПОДТВЕРЖДЕНИЕ

На основе карты процесса выделены события:

Domain Events:
1. <EventName1> (из UC-01)
   - Триггер: CMD <CommandName>
   - Publisher: <BC>
   - Subscribers: <BC1>, <BC2>
   - Предполагаемый payload: <ключевые поля>

2. <EventName2> (из UC-01)
   - Триггер: <что вызывает>
   - Publisher: <BC>
   - Subscribers: <BC>

Integration Events (если есть):
1. <EventName3>
   - Источник: <внешняя система или другой домен>
   - Получатель: <BC>

Вопросы для уточнения:
- <Нужно ли событие X или достаточно Y?>
- <Какие поля обязательны в payload?>

Пожалуйста, подтвердите список событий или укажите корректировки.
```

### Шаг 3. Ожидание подтверждения

Агент ожидает ответа разработчика:
- "Подтверждаю" — переход к детализации
- Корректировки — агент вносит изменения и повторяет подтверждение

### Шаг 4. Детализация после подтверждения

После подтверждения агент:
1. Создает реестр событий в табличном формате
2. Создает детальные карточки для ключевых событий
3. Добавляет JSON-примеры
4. Прописывает гарантии доставки и SLA

**Почему это важно:**
- События — контракты между BC и основа для интеграций
- Неверное событие = неверный контракт = проблемы при реализации
- Payload определяет, какие данные передаются между компонентами

---

## Связь: Карта процесса -> Каталог мероприятий

**Вход (из карты процесса):**
```
1. Customer -> **(CMD) CreateOrder** -> Order-BC
2. Order-BC -> **(EVT) OrderCreated**
3. Order-BC -> **(CMD) ReserveItems** -> Inventory-BC
4. Inventory-BC -> **(EVT) ItemsReserved**
```

**Выход (в каталог мероприятий):**

| Event | Тип | Trigger | Publisher | Subscribers | Payload |
|-------|-----|---------|-----------|-------------|---------|
| OrderCreated | Domain | CMD: CreateOrder | Order-BC | Inventory-BC | orderId, customerId, items[], totalAmount |
| ItemsReserved | Domain | CMD: ReserveItems | Inventory-BC | Order-BC | orderId, reservationId, items[] |

**Плюс карточки событий** с детальным payload и JSON-примерами.

---

## 0. Контекст документа
- **Проект / продукт:** `<project-name>`
- **Домен (slug):** `<domain_slug>`
- **Дата обновления:** `<YYYY-MM-DD>`
- **Владелец каталога:** `<team/person>`
- **Связанные документы (формат):**
  - Карта процесса домена: `docs/requirements/сценарии/<domain_slug>/карта процесса.md`
  - Карточка домена: `docs/requirements/домены/<domain_slug>.md`

## 1. Конвенции

### 1.1 Классификация событий
- **Domain Event:** факт в домене (важен бизнесу)
- **Integration Event:** событие для межконтекстного взаимодействия
- **Technical Event:** технический сигнал (лог/метрика/инфраструктура) — по возможности отдельно

### 1.2 Общая оболочка события (envelope)
Минимум рекомендуется:
- `eventId` (UUID)
- `eventType`
- `eventVersion`
- `occurredAt` (ISO-8601)
- `correlationId`
- `causationId`
- `producer` (service/BC)
- `payload` (business fields)

### 1.3 Идемпотентность и доставка
- **Delivery:** `<at-least-once|exactly-once|at-most-once>`
- **Idempotency key:** `<eventId|domainId+sequence|...>`

## 2. Реестр событий (таблица)
> Заполни сначала таблицу, потом — подробные карточки для ключевых EVT.

| Event (EVT) | Тип (Domain/Integration/Technical) | Причина (Trigger) | Владелец (Publisher BC) | Потребители (Subscribers) | Payload (минимум) | SLA/критичность | Примечания |
|---|---|---|---|---|---|---|---|
| `<EventName>` | `<type>` | `<cmd/policy/ext>` | `<BC>` | `<BCs>` | `<fields>` | `<P1/P2/P3>` | `<notes>` |
| `<EventName>` | `<type>` |  |  |  |  |  |  |

## 3. Карточки событий (подробно)

### 3.1 EVT: `<EventName>`
- **Тип:** `<Domain|Integration|Technical>`
- **Описание:** `<what fact happened>`
- **Когда публикуется:** `<conditions>`
- **Кто публикует (BC/service):** `<publisher>`
- **Кто потребляет:** `<subscribers + why>`
- **Команда/политика-источник:** `<CMD|POL name>`
- **Связанные события:** `<previous/next>`

#### 3.1.1 Payload (поля)
| Поле | Тип | Обязательность | Описание | Пример |
|---|---|---:|---|---|
| `<field>` | `<type>` | `yes/no` | `<meaning>` | `<example>` |
| `<field>` | `<type>` |  |  |  |

#### 3.1.2 Пример события (JSON)
```json
{
  "eventId": "<uuid>",
  "eventType": "<EventName>",
  "eventVersion": 1,
  "occurredAt": "<ISO-8601>",
  "correlationId": "<id>",
  "causationId": "<id>",
  "producer": "<service-or-bc>",
  "payload": {
    "<field1>": "<value>",
    "<field2>": "<value>"
  }
}
```

### 3.1.3 Семантика и гарантии

* **Идемпотентность:** `<how>` — какой ключ используется (например, `eventId` или `domainId+sequence`).
* **Доставка (delivery):** `<at-least-once|exactly-once|at-most-once>` — ожидаемая семантика.
* **Порядок (ordering):** `<none|per-key|global>` — правила упорядочивания (например, per-key по entityId).
* **Совместимость версий:** `<rules>` — политика backward/forward, использование `eventVersion`/`schemaVersion`.
* **Ошибки и ретраи:** `<policy>` — ретраи, DLQ, обработка “poison messages”.
* **SLA / критичность:** `<P1|P2|P3>` и ожидаемое время реакции/восстановления.
* **Мониторинг и алерты:** метрики (`events.published`, `events.failed`, `events.retries`), пороги, алерты.

#### 3.1.4 Тестирование и контракт

* **Contract tests:** где хранится схема (JSON Schema / Avro / Protobuf), путь к тестам, как запускать (CI job).
* **Golden samples:** `<paths>` — примеры событий для контрактных тестов / интеграции.
* **Валидация:** проверка схемы у производителя и потребителя; тесты на совместимость версий.
* **Contract verification:** требования к CI (PR должен запускать контракт-тесты или проверку схемы).

#### 3.1.5 Метаданные и трассировка

* Рекомендуется включать `correlationId`, `causationId`, `traceparent/traceid` (если есть distributed tracing).
* Логирование: стандартизированные поля (`eventId`, `eventType`, `producer`, `status`).

---

### 3.2 EVT: `<EventName>` (шаблон)

> Скопируйте структуру карточки из раздела **3.1** и заполните поля под конкретное событие.

* **Тип:** `<Domain|Integration|Technical>`
* **Описание:** `<что произошло в домене>`
* **Когда публикуется:** `<условия>`
* **Кто публикует (BC/service):** `<publisher>`
* **Кто потребляет:** `<subscribers + зачем>`
* **Команда / политика-источник:** `<CMD|POL>`
* **Связанные события:** `<previous/next>`

**Payload (минимум):** перечислить поля в таблице (см. 3.1.1)
**Пример события (JSON):** добавить JSON-пример и golden samples в репозиторий.

---

## 4. Статусы и жизненные циклы (опционально)

* **Entity:** `<Order|Document|...>`
* **Статусы:** перечислить (например, `Draft → Submitted → Paid → Shipped → Completed → Cancelled`).

**Пример таблицы переходов:**

| From        | Event              | To          | Комментарий                   |
| ----------- | ------------------ | ----------- | ----------------------------- |
| `Draft`     | `OrderSubmitted`   | `Submitted` | Создание заказа пользователем |
| `Submitted` | `PaymentConfirmed` | `Paid`      | Платёж успешно прошёл         |
| `Paid`      | `ShipmentCreated`  | `Shipped`   | Отправка заказа               |

* Укажите гарантии: какие события окончательные, какие могут компенсироваться, есть ли compensating actions.

---

## 5. Связь с тестированием (опционально)

* **Contract tests:** где и как запускаются (CI, schema registry, consumer-driven contract tests).
* **Golden samples:** путь в репозитории (`/tests/golden/<event-name>.json`) и правила обновления.
* **Integration tests:** энд-то-энд тесты, окружения, тестовые топики/каналы.
* **Monitoring:** метрики на событие, SLOs, алерты (рост `events.failed` или падение throughput).
* **Acceptance criteria:** критерии приёма по контрактам (все потребители проходят contract tests при изменении схемы).

---

## Критерии готовности этапа [5.2]

### Минимальные (блокируют переход к [5.3])

- [ ] **События в домене:** >= 3 события извлечены из карты процесса
- [ ] **Реестр событий:** таблица с колонками Event, Тип, Trigger, Publisher, Subscribers, Payload, SLA
- [ ] **Карточки событий:** >= 1 детальная карточка для ключевого события
- [ ] **Payload:** >= 4 бизнес-поля для ключевых событий (не только ID и timestamp)
- [ ] **Publisher/Subscriber:** указаны для каждого события в реестре
- [ ] **JSON-пример:** минимум 1 пример события в формате JSON
- [ ] **H8 создан:** `docs/requirements/сценарии/<domain_slug>/каталог мероприятий.md`

### Рекомендуемые

- [ ] **Типизация:** события классифицированы (Domain/Integration/Technical)
- [ ] **Версионирование:** указан eventVersion/schemaVersion
- [ ] **Семантика доставки:** указаны гарантии (at-least-once, exactly-once)
- [ ] **Idempotency:** описан ключ идемпотентности
- [ ] **Статусы и жизненные циклы:** раздел 4 заполнен (если применимо)

### Gap Tracking

- [ ] `gap-tracking.md` обновлен (если есть пробелы)
- [ ] Пробелы помечены как `Не определено источниками`
- [ ] НЕТ придуманных событий — только факты из карты процесса
