# TDD манифест (Test-Driven Development)

Правила TDD и тестирования для проекта. Документ обязателен для разработчиков и используется агентами как политика действий.

---

## 0. Контекст
- **Проект:** `<PROJECT_NAME>`
- **Стек/рантайм (факты проекта):** см. `docs/requirements/структураПО/стек проекта.md`
- **Сценарии (факты проекта):** см. `docs/сценарии/**`
- **Требования (факты проекта):** см. `docs/requirements/требования/**`
- **Дата обновления:** `<YYYY-MM-DD>`
- **Ответственный:** `<team/person>`

> Примечание: `.requirements/**` — методики/шаблоны (read-only).  
> Источниками истины для тестов являются `.tasks/.issues` и фактические документы в `docs/**` (REQ/SC/контракты).

---

## 1. Триггеры: когда агент имеет право создавать/изменять тесты
Агент **создаёт или меняет тесты только при наличии явного основания**:

1) Есть активная задача в `.tasks` (включая требование “добавить/обновить тесты”).  
2) Есть issue в `.issues` (особенно bug: обязателен регрессионный тест).  
3) В `.manifest/**` явно прописан кейс `TEST_REQUIRED` / `MUST_HAVE_TEST` (например: security-критичные изменения, изменения контрактов).  

**Уточнение (снимает конфликт с TDD):**  
Если `.tasks/.issues` подразумевают **изменение поведения** (фича/баг/контракт), то **тест обязателен по умолчанию**, даже если в тексте задачи не написано “добавь тест”.

Если явного основания нет — агент **не генерирует тестовый код**, а даёт рекомендации: какой тест нужен, где разместить, как запускать.

---

## 2. Процесс TDD: Red → Green → Refactor
**Для изменений поведения** (фича/баг/контракт) применяется цикл:

- **Red:** сначала тест, который падает по корректной причине (одна причина падения).
- **Green:** минимальный код для прохождения теста.
- **Refactor:** улучшение кода без изменения поведения при зелёных тестах.

Исключения допускаются только если это явно разрешено в `.manifest/**` и затем покрывается тестами с указанием этой особенности.

---

## 3. Что именно тестируем
Тесты должны проверять **требования и выполненную задачу**, а не “фиктивно проходить”.

- Каждый новый/обновлённый тест обязан иметь **ссылку/ID** на источник:
  - `.tasks/<id>` или `.issues/<id>` или `REQ-xx` / `SC-xx`.
- Запрещены тесты без проверяемой бизнес/технической сути (пустые asserts, “просто чтобы зелёным было”).
- Запрещено тестировать детали реализации, если это не контракт: тестируем **наблюдаемое поведение**, инварианты, публичные интерфейсы.

> Если у сценариев/требований нет ID, допускается ссылка путём на фактический документ:
> - `docs/requirements/требования/**`
> - `docs/сценарии/**`

---

## 4. Уровни тестов и правило “самый дешёвый уровень”
По умолчанию выбирается **самый дешёвый** уровень, который доказывает требование:

1) **Unit** — основной уровень (быстрый, изоляция, без сети/БД).  
2) **Component/Service** *(опц.)* — проверка компонента in-memory (без реальных внешних сервисов).  
3) **Integration** — реальная БД/очередь/ФС в воспроизводимой среде (контейнеры).  
4) **Contract** — совместимость API/событий/схем между producer/consumer.  
5) **E2E/Acceptance** — только критические сценарии, минимум количества.

Поднимать уровень выше разрешено только если unit/component не может доказать требование (обосновать в PR/отчёте).

### 4.1 Контракты (источник истины)
- **Source of truth для контрактов:** `<path>` (например: `contracts/`, `docs/contracts/`, `api/openapi.yaml`, `asyncapi.yaml`, `schemas/*.json`).
- Любое изменение API/событий/схем должно сопровождаться **синхронным обновлением**:
  - схем/контрактов,
  - contract tests,
  - потребителей/производителей (если применимо).

---

## 5. Политика изменения тестов: дополнять vs создавать новые
- По умолчанию агент **дополняет/правит существующие тесты** в релевантном файле рядом с кодом.
- Новый тестовый файл создаётся, если:
  - подходящего файла нет;
  - новый модуль/контекст/уровень теста;
  - файл стал слишком большим или смешивает разные уровни.
- Агент **не создаёт новые тесты без основания** (см. раздел 1).

---

## 6. Детерминизм, изоляция, отсутствие флейков
Тесты должны быть:
- быстрыми (особенно unit),
- детерминированными,
- независимыми от порядка выполнения,
- допускающими параллельный запуск.

Технические правила:
- не использовать `sleep` вместо ожиданий условия;
- фиксировать время (fake clock) и seed случайности;
- изолировать состояние (очистка/транзакции/fixtures);
- не зависеть от внешних нестабильных сервисов (stub/контейнеры/recorded responses);
- запрещены “общие” mutable глобальные фикстуры без строгой изоляции.

**Flaky policy:** “fix or quarantine + ticket”. Флейк — приоритетный долг.

---

## 7. Границы моков (чтобы тесты не теряли смысл)
- Мокать/подменять допустимо **границы**: сеть, ФС, БД, очередь, время, случайность, внешние API.
- Не мокать доменную логику и ключевые инварианты.
- Предпочтение: **fakes/in-memory adapters** вместо deep-mocks.
- Любой мок должен улучшать детерминизм/скорость и не превращать тест в tautology.

---

## 8. Запрет на “лечить падения ослаблением”
Нельзя “чинить тесты” такими способами без явного обоснования и ссылки на `.tasks/.issues`:
- расширять таймауты “на всякий случай”,
- убирать проверки/assert’ы,
- мокать всё подряд (теряя смысл),
- превращать тест в tautology (проверяет то, что сам же подменил).

Если поведение изменилось легитимно — обновлять ожидания, но фиксировать причину (ссылка на задачу/требование).

---

## 9. Актуальность старых тестов
При изменениях агент обязан:
- **проверить релевантные старые тесты**,
- **адаптировать** их к новым условиям, если они стали неактуальны,
- при невозможности сразу стабилизировать — **quarantine** с причиной, владельцем и сроком.

### 9.1 Что считается “релевантными тестами”
Релевантны тесты, которые:
- находятся в том же модуле/пакете/BC, что и изменённый код;
- проверяют те же `REQ-xx`/`SC-xx` или ссылаются на ту же `.tasks/.issues`;
- относятся к изменённым контрактам (OpenAPI/AsyncAPI/JSONSchema/DTO);
- затрагиваются изменениями интерфейсов/переименований/сигнатур.

Агент **не удаляет тесты молча**: удаление/перенос только с явным основанием и записью в отчёте.

### 9.2 Quarantine (единый механизм)
- Маркер/тег: `<tag>` (например: `@quarantine` / `@flaky`)
- Отдельная команда запуска: `make test:quarantine` (или эквивалент)
- Обязательные поля: **причина**, **owner**, **срок возврата**, **ссылка на issue/task**  
- Quarantine не должен быть “вечным”: должен быть план возврата в основной прогон.

---

## 10. Запуск и CI (стандартизированные профили)
Проект обязан иметь стандартизированный запуск (пример):

- `make test` — быстрый профиль (unit + быстрые component)
- `make test:ci` — полный профиль (unit + integration + contract)
- `make test:e2e` — e2e/acceptance (если отдельно)
- `make test:coverage` — отчёт покрытия (если нужен)
- `make test:quarantine` — quarantined/flaky (если используется)

Тесты должны давать диагностируемые артефакты при падении (логи, junit/coverage, скриншоты/дампы при необходимости).

### 10.1 Coverage
- Coverage — **ориентир**, не единственный KPI качества.
- Пороги (если применимо): statements `<X%>`, branches `<Y%>`; исключения документируются (why + link).

> TODO: определить пороги покрытия и правила исключений (ссылка на решение/задачу).

---

## 11. Правила для агентов (поведение и отчётность)
- Агент **может генерировать тесты**, но не выполняет “молчаливые” изменения без явного основания (раздел 1).
- В отчёте агент обязан указать:
  - какие тесты добавлены/изменены и почему (ссылки на `.tasks/.issues/REQ/SC`);
  - уровень теста и обоснование выбора уровня;
  - команды запуска и ожидаемый результат;
  - если запуск действительно выполнен агентом — приложить вывод; если нет — явно указать, что не запускал.
- Для регрессионных багов — обязателен тест, воспроизводящий баг (Red).
- Любые изменения контрактов требуют обновления схем + contract tests (раздел 4.1).

---

## 12. Definition of Done для теста
Тест считается готовым, если:
- покрывает требование/задачу и имеет ссылку на источник (ID);
- стабилен, детерминирован и независим от порядка выполнения;
- запускается в CI (в соответствующем профиле);
- читабелен (имя, структура AAA/GWT, минимум моков, без тестирования деталей реализации);
- при падении даёт понятную диагностику и артефакты.

---

## 13. Мини-карточка теста (обязательна для новых/существенно изменённых тестов)
Каждый **новый** тест и каждый тест, который **существенно меняет смысл проверки**, должен иметь мини-карточку вначале кода.
Карточка размещается:
- либо **комментарием прямо над тестом** (предпочтительно),
- либо в **описании PR/отчёте агента**, если формат тестов не позволяет удобно вставить комментарий.

Цель карточки: быстро понять **зачем существует тест**, к чему он привязан, и на каком уровне он выполняется.

**Шаблон:**
- **ID:** `TEST-###` (уникально в рамках репозитория/модуля)
- **Источник:** `.tasks/<id>` или `.issues/<id>` или `REQ-xx` / `SC-xx`
- **Уровень:** `unit | component | integration | contract | e2e`
- **Given:** `<начальные условия/состояние>`
- **When:** `<действие/вызов>`
- **Then:** `<ожидаемый результат/инвариант>`

**Пример (как комментарий):**
- ID: `TEST-014`
- Источник: `.issues/BUG-33`
- Уровень: `unit`
- Given: пользователь без роли `admin`
- When: вызывает endpoint удаления
- Then: получает `403` и данные не изменяются
