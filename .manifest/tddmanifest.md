# TDD Manifest (H2)

Политики и стандарты Test-Driven Development: цикл Red-Green-Refactor, уровни тестов, детерминизм и правила для агента.

---

## tdd.H3.1 Создавай тесты только при наличии задачи или issue
Тесты создаются на основании явных требований, не спекулятивно.
**Почему важно:**
Тесты без основания захламляют кодовую базу, тестируют несуществующие требования, тормозят разработку.

---

## tdd.H4.1 Когда создавать тесты
Агент создает или меняет тесты только при наличии явного основания:
1. Есть активная задача в `.tasks` (включая требование "добавить/обновить тесты")
2. Есть issue в `.issues` (особенно bug: обязателен регрессионный тест)
3. В `.manifest/**` явно прописан кейс `TEST_REQUIRED` / `MUST_HAVE_TEST` (например: security-критичные изменения, изменения контрактов)
**Уточнение (снимает конфликт с TDD):**
Если `.tasks/.issues` подразумевают изменение поведения (фича/баг/контракт), то тест обязателен по умолчанию, даже если в тексте задачи не написано "добавь тест".
**Если явного основания нет:**
Агент не генерирует тестовый код, а дает рекомендации: какой тест нужен, где разместить, как запускать.

---

## tdd.H3.2 Сначала тест потом код
Для изменений поведения применяется цикл Red → Green → Refactor.
**Почему важно:**
TDD обеспечивает проверяемость до написания кода, минимальную реализацию, защиту от регрессии.

---

## tdd.H4.2 Цикл Red-Green-Refactor
Для изменений поведения (фича/баг/контракт) применяй цикл:
- **Red:** Сначала тест который падает по корректной причине (одна причина падения)
- **Green:** Минимальный код для прохождения теста
- **Refactor:** Улучшение кода без изменения поведения при зеленых тестах
Исключения допускаются только если это явно разрешено в `.manifest/**` и затем покрывается тестами с указанием этой особенности.

---

## tdd.H3.3 Тестируй требования не детали реализации
Тесты проверяют требования и выполненную задачу, не внутреннюю механику.
**Почему важно:**
Тесты деталей реализации хрупкие, ломаются при рефакторинге, не защищают контракты.

---

## tdd.H4.3 Правила тестирования требований
**Каждый новый/обновленный тест обязан иметь ссылку/ID на источник:**
- `.tasks/<id>` или `.issues/<id>` или `REQ-xx` / `SC-xx`
**Запрещено:**
- Тесты без проверяемой бизнес/технической сути (пустые asserts, "просто чтобы зеленым было")
- Тестировать детали реализации если это не контракт: тестируем наблюдаемое поведение, инварианты, публичные интерфейсы
**Если у сценариев/требований нет ID:**
Допускается ссылка путем на фактический документ:
- `docs/requirements/требования/**`
- `docs/сценарии/**`

---

## tdd.H3.4 Выбирай самый дешевый уровень теста
По умолчанию выбирай самый дешевый уровень который доказывает требование.
**Почему важно:**
Дорогие тесты (E2E) медленные, хрупкие, сложны в поддержке. Пирамида тестов экономит время и деньги.

---

## tdd.H4.4 Уровни тестов
По умолчанию выбирай самый дешевый уровень который доказывает требование:
1. **Unit** - основной уровень (быстрый, изоляция, без сети/БД)
2. **Component/Service** - проверка компонента in-memory (без реальных внешних сервисов)
3. **Integration** - реальная БД/очередь/ФС в воспроизводимой среде (контейнеры)
4. **Contract** - совместимость API/событий/схем между producer/consumer
5. **E2E/Acceptance** - только критические сценарии, минимум количества
Поднимать уровень выше разрешено только если unit/component не может доказать требование (обосновать в PR/отчете).

---

## tdd.H4.5 Контракты (источник истины)
**Source of truth для контрактов:**
`<path>` (например: `contracts/`, `docs/contracts/`, `api/openapi.yaml`, `asyncapi.yaml`, `schemas/*.json`)
**Любое изменение API/событий/схем должно сопровождаться синхронным обновлением:**
- Схем/контрактов
- Contract tests
- Потребителей/производителей (если применимо)

---

## tdd.H3.5 Обеспечь детерминизм и изоляцию
Тесты должны быть быстрыми, детерминированными, независимыми от порядка выполнения.
**Почему важно:**
Flaky тесты убивают доверие к CI, тратят время команды на ложные срабатывания.

---

## tdd.H4.6 Технические правила детерминизма
Тесты должны быть:
- Быстрыми (особенно unit)
- Детерминированными
- Независимыми от порядка выполнения
- Допускающими параллельный запуск
**Технические правила:**
- Не использовать `sleep` вместо ожиданий условия
- Фиксировать время (fake clock) и seed случайности
- Изолировать состояние (очистка/транзакции/fixtures)
- Не зависеть от внешних нестабильных сервисов (stub/контейнеры/recorded responses)
- Запрещены "общие" mutable глобальные фикстуры без строгой изоляции
**Flaky policy:**
"Fix or quarantine + ticket". Флейк - приоритетный долг.

---

## tdd.H4.7 Мокай только границы
**Мокать/подменять допустимо границы:**
Сеть, ФС, БД, очередь, время, случайность, внешние API
**Не мокать:**
Доменную логику и ключевые инварианты
**Предпочтение:**
Fakes/in-memory adapters вместо deep-mocks
**Правило:**
Любой мок должен улучшать детерминизм/скорость и не превращать тест в tautology.

---

## tdd.H3.6 Не лечи падения ослаблением тестов
При падении тестов исправляй проблему, не ослабляй проверки.
**Почему важно:**
Ослабление тестов маскирует реальные проблемы, снижает покрытие, приводит к регрессиям.

---

## tdd.H4.8 Запрещенные способы "чинить тесты"
Нельзя "чинить тесты" без явного обоснования и ссылки на `.tasks/.issues`:
- Расширять таймауты "на всякий случай"
- Убирать проверки/assert'ы
- Мокать всё подряд (теряя смысл)
- Превращать тест в tautology (проверяет то что сам же подменил)
Если поведение изменилось легитимно - обновляй ожидания, но фиксируй причину (ссылка на задачу/требование).

---

## tdd.H4.9 Проверяй и адаптируй релевантные старые тесты
При изменениях агент обязан:
- Проверить релевантные старые тесты
- Адаптировать их к новым условиям если они стали неактуальны
- При невозможности сразу стабилизировать - quarantine с причиной, владельцем и сроком
**Что считается "релевантными тестами":**
- Находятся в том же модуле/пакете/BC что и измененный код
- Проверяют те же `REQ-xx`/`SC-xx` или ссылаются на ту же `.tasks/.issues`
- Относятся к измененным контрактам (OpenAPI/AsyncAPI/JSONSchema/DTO)
- Затрагиваются изменениями интерфейсов/переименований/сигнатур
**Агент не удаляет тесты молча:**
Удаление/перенос только с явным основанием и записью в отчете.

---

## tdd.H4.10 Quarantine (единый механизм)
- Маркер/тег: `<tag>` (например: `@quarantine` / `@flaky`)
- Отдельная команда запуска: `make test:quarantine`
- Обязательные поля: причина, owner, срок возврата, ссылка на issue/task
- Quarantine не должен быть "вечным": должен быть план возврата в основной прогон

---

## tdd.H4.11 Стандартизируй запуск тестов
Проект обязан иметь стандартизированный запуск:
- `make test` - быстрый профиль (unit + быстрые component)
- `make test:ci` - полный профиль (unit + integration + contract)
- `make test:e2e` - e2e/acceptance (если отдельно)
- `make test:coverage` - отчет покрытия (если нужен)
- `make test:quarantine` - quarantined/flaky (если используется)
Тесты должны давать диагностируемые артефакты при падении (логи, junit/coverage, скриншоты/дампы при необходимости).
**Coverage:**
- Coverage - ориентир, не единственный KPI качества
- Пороги (если применимо): statements `<X%>`, branches `<Y%>`; исключения документируются (why + link)

---

## tdd.H4.12 Дополняй существующие тесты
- По умолчанию агент дополняет/правит существующие тесты в релевантном файле рядом с кодом
- Новый тестовый файл создается если:
  - Подходящего файла нет
  - Новый модуль/контекст/уровень теста
  - Файл стал слишком большим или смешивает разные уровни
- Агент не создает новые тесты без основания (см. tdd.H4.1)

---

## tdd.H4.13 Правила для агента
**Агент может генерировать тесты, но:**
- Не выполняет "молчаливые" изменения без явного основания (tdd.H4.1)
**В отчете агент обязан указать:**
- Какие тесты добавлены/изменены и почему (ссылки на `.tasks/.issues/REQ/SC`)
- Уровень теста и обоснование выбора уровня
- Команды запуска и ожидаемый результат
- Если запуск действительно выполнен агентом - приложить вывод; если нет - явно указать что не запускал
**Для регрессионных багов:**
Обязателен тест воспроизводящий баг (Red).
**Любые изменения контрактов:**
Требуют обновления схем + contract tests (tdd.H4.5).

---

## tdd.H4.14 Мини-карточка теста
Каждый новый тест и каждый тест который существенно меняет смысл проверки должен иметь мини-карточку.
**Карточка размещается:**
- Комментарием прямо над тестом (предпочтительно)
- В описании PR/отчете агента (если формат тестов не позволяет)
**Шаблон:**
- **ID:** `TEST-###` (уникально в рамках репозитория/модуля)
- **Источник:** `.tasks/<id>` или `.issues/<id>` или `REQ-xx` / `SC-xx`
- **Уровень:** `unit | component | integration | contract | e2e`
- **Given:** `<начальные условия/состояние>`
- **When:** `<действие/вызов>`
- **Then:** `<ожидаемый результат/инвариант>`
**Пример (как комментарий):**
```
- ID: TEST-014
- Источник: .issues/BUG-33
- Уровень: unit
- Given: пользователь без роли admin
- When: вызывает endpoint удаления
- Then: получает 403 и данные не изменяются
```

---

## tdd.H4.15 Definition of Done теста
Тест считается готовым если:
- [ ] Покрывает требование/задачу и имеет ссылку на источник (ID)
- [ ] Стабилен детерминирован и независим от порядка выполнения
- [ ] Запускается в CI (в соответствующем профиле)
- [ ] Читабелен (имя, структура AAA/GWT, минимум моков, без тестирования деталей реализации)
- [ ] При падении дает понятную диагностику и артефакты
