# SDD Manifest (H2)

Политики и стандарты Specification-Driven Development: последовательность этапов, взаимодействие агента и разработчика, gap-tracking.

---

## sdd.H3.1 Прими системные правила перед началом
Агент должен принять правила проекта до начала работы над документацией.
**Почему важно:**
Без знания правил агент генерирует контент, не соответствующий стандартам проекта, требуется переделка.

---

## sdd.H4.1 Процедура принятия системных правил
**Разработчик инициирует:**
```
Прими системные правила из .claude/CLAUDE.md или .github\agents\copilot-instructions.md или AGENTS.md
Мы выполняем задачу по разработке технической документации.
```
**Агент подтверждает:**
```
Системные правила приняты. Готов к работе по SDD.
```
**Файлы для чтения:**
- `.claude/CLAUDE.md` (для Claude) или `.github/copilot-instructions.md` (для Copilot) или `AGENTS.md`
- `.manifest/sddmanifest.md` (этот файл)

---

## sdd.H3.2 Изучи исходные данные в .source/
Папка `.source/` содержит неструктурированные входные данные для анализа перед началом работы.
**Почему важно:**
Без анализа источников агент придумывает требования из обучающих данных, результат не соответствует задаче.

---

## sdd.H4.2 Процедура анализа .source/
**Содержимое .source/:**
- Идеи и концепции
- Черновики требований
- Переписка с заказчиком
- Ссылки на аналоги
- Любые материалы, описывающие задачу
**Агент обязан:**
1. Прочитать все файлы в `.source/`
2. Составить краткое резюме понятого контекста
3. Выявить пробелы и неясности
**Агент НЕ должен:**
- Начинать документирование без анализа `.source/`
- Предполагать данные, которых нет в источниках

---

## sdd.H3.3 Строй артефакты самостоятельно
Агент самостоятельно строит артефакты на основе источников, логики и best practices. Вопросы только при невозможности решить самому.
**Почему важно:**
Избыточные вопросы тормозят работу. Агент должен принимать решения, где это возможно.

---

## sdd.H4.3 Правила уточняющих вопросов
**Агент задает вопросы ТОЛЬКО в двух случаях:**
| Тип вопроса | Когда задавать |
|-------------|----------------|
| Выбор из вариантов | Есть несколько равноценных решений, агент не может выбрать лучшее |
| Разрешение коллизии | Противоречие, разночтение или неточность в источниках |
**Формат вопросов:**
```
ТРЕБУЕТСЯ РЕШЕНИЕ РАЗРАБОТЧИКА

Выбор из вариантов:
1. <Вариант A>: <плюсы/минусы>
2. <Вариант B>: <плюсы/минусы>
Рекомендация агента: <вариант> потому что <причина>

Коллизии:
- <Описание противоречия>
  Источник 1: ...
  Источник 2: ...
  Вопрос: какой вариант верный?
```
**Агент НЕ спрашивает:**
- То, что выводится логически из предыдущих этапов
- То, что определяется best practices отрасли
- Очевидные вещи из контекста
- Детали, которые определятся на следующих этапах

---

## sdd.H4.4 Процедура подтверждения базового контекста
**Базовый контекст (особый случай):**
Если `.source/` содержит неполную информацию о фундаментальных вещах (название системы, определение, ключевая проблема, целевая аудитория), агент должен сформулировать их сам и запросить подтверждение.
**Алгоритм:**
1. Агент анализирует `.source/` и формулирует базовый контекст
2. Помечает сформулированное маркером `<!-- @base-context -->`
3. Выводит блок "БАЗОВЫЙ КОНТЕКСТ — ТРЕБУЕТСЯ ПОДТВЕРЖДЕНИЕ"
4. Ожидает реакции разработчика
5. Если разработчик вносит правки - агент обновляет артефакт
6. Если разработчик не подтверждает - создается GAP
**Формат вывода:**
```
БАЗОВЫЙ КОНТЕКСТ — ТРЕБУЕТСЯ ПОДТВЕРЖДЕНИЕ

На основе анализа .source/ агент сформулировал:

Название системы: <название>
Определение: <что это и зачем>
Ключевая проблема: <какую проблему решает>
Целевая аудитория: <для кого>

Это станет основой всей документации.
Пожалуйста, подтвердите или скорректируйте.
```
**Маркер в артефакте:**
```markdown
<!-- @base-context: название системы, определение — сформулировано агентом, требует подтверждения -->
## 1. Название и назначение

**Название системы:** CodeReview Assistant
**Определение:** Система автоматизации code review для GitHub-репозиториев
```
**После подтверждения:**
- Агент удаляет маркер `<!-- @base-context -->`
- Продолжает работу
**Если нет подтверждения:**
- Агент создает GAP с критичностью HIGH
- GAP блокирует все последующие этапы

---

## sdd.H3.4 Следуй треку разработки пошагово
Агент выполняет этапы строго по одному согласно треку разработки.
**Почему важно:**
Пропуск или перестановка этапов ведет к неполной документации, несоответствиям между этапами.

---

## sdd.H4.5 Последовательность этапов
После получения ответов агент читает `.requirements/трек разработки.md` и выполняет этапы строго по одному:
```
[1] Предметная область → [2] Обоснование выбора → [3] Требования →
[4] Домены → [5] Сценарии → [5.5] Диаграммы сценариев →
[6] Структура данных → [7] Архитектура → [7.1] Диаграммы ArchiMate →
[8] Структура ПО → [9] Тестирование
```

---

## sdd.H4.6 Правило одного этапа
Агент выполняет ТОЛЬКО ОДИН этап за запрос:
1. Читает шаблон из `.requirements/`
2. Создает артефакт в `docs/requirements/`
3. Выводит отчет о завершении
4. ОСТАНАВЛИВАЕТСЯ и ждет команды
**Запрещенные действия:**
- Выполнять несколько этапов в одном ответе
- Автоматически переходить к следующему этапу
- Пропускать этапы без явного указания разработчика

---

## sdd.H4.7 Правило полного завершения
Агент НЕ ПЕРЕХОДИТ к следующему этапу, пока текущий не выполнен полностью.
**"Не определено источниками" недопустимо в финальном артефакте.**
**Процедура:**
1. Проверь на "Не определено"
2. Попытайся достроить самостоятельно (логика + best practices)
3. Если не можешь решить сам - спроси разработчика (выбор/коллизия)
4. Дострой артефакт после ответов
5. Повтори проверку пока артефакт не будет полным
**Запрещено:**
- Оставлять "Не определено" в финальном артефакте
- Переходить к следующему этапу с неполным текущим

---

## sdd.H4.8 Критерии детализации артефактов
ОБЯЗАТЕЛЬНО: Перед созданием артефакта агент изучает примеры "Считать верным/неверным" в шаблоне.
**Каждый шаблон содержит:**
1. Считать верным - достаточная детализация, на которую нужно ориентироваться
2. Считать неверным - недостаточная детализация, которую нельзя допускать
3. Минимальные критерии - количественные требования (>= N элементов)
4. Правила извлечения данных - откуда брать информацию
**Ключевые критерии по этапам:**
| Этап | Ключевой критерий | Где примеры |
|------|-------------------|-------------|
| [4] Домены | scope_in >= 3, owned_data >= 1 сущность с атрибутами | `.requirements/домены/определение доменов.md`, раздел 4.1 |
| [5] Карта процесса | UC >= 5 шагов, CMD >= 2, EVT >= 2 | `.requirements/сценарии/карта процесса.md` |
| [5] Каталог мероприятий | События >= 3, payload >= 4 поля, JSON-пример | `.requirements/сценарии/каталог мероприятий.md` |
| [5] Ограниченные контексты | BC >= 5 пунктов описания, Integration Matrix | `.requirements/сценарии/ограниченные контексты.md` |
**Правило:** Если артефакт похож на "Считать неверным" - агент ОБЯЗАН детализировать до уровня "Считать верным".

---

## sdd.H4.9 Работа с placeholder'ами
При создании документа агент часто не знает конкретных значений (имена доменов на этапе [1]).
**Правило:**
1. Ставь маркер `<!-- @update-after:[N] Описание -->` перед placeholder'ом
2. После завершения этапа [N] - найди все маркеры и замени на реальные значения
3. Если placeholder не может быть заполнен - создай GAP
**Типичные placeholder'ы:**
| Placeholder | Обновлять после |
|-------------|-----------------|
| `<domain_slug>` | [4] Домены |
| `<BC-name>` | [5] Сценарии |
| `<table_name>` | [6] Структура данных |
| `<component>` | [7] Архитектура |

---

## sdd.H4.10 Точки подтверждения кандидатов
На некоторых этапах агент формирует перечень кандидатов и запрашивает подтверждение разработчика перед детальной работой.
**Этапы с подтверждением:**
| Этап | Что подтверждается |
|------|--------------------|
| [2] Обоснование выбора | Стандарт, методология, паттерн, стек |
| [6] Структура данных | Модель хранения, перечень объектов |
| [7 BL/AL/TL] Архитектура | Сущности слоя (акторы, компоненты, узлы) |
**Алгоритм:**
1. Агент формулирует перечень кандидатов на основе предыдущих этапов
2. Выводит блок "КАНДИДАТЫ — ТРЕБУЕТСЯ ПОДТВЕРЖДЕНИЕ"
3. Ожидает подтверждения или корректировки
4. После подтверждения - детализирует каждого кандидата
**Формат вывода:**
```
КАНДИДАТЫ [этап] — ТРЕБУЕТСЯ ПОДТВЕРЖДЕНИЕ

На основе [источник] агент сформулировал:
1. <кандидат 1> — <краткое описание>
2. <кандидат 2> — <краткое описание>

Подтвердите список или скорректируйте.
```

---

## sdd.H3.5 Останавливайся после каждого этапа
Агент останавливается после каждого этапа и ждет команды разработчика.
**Почему важно:**
Без остановок невозможен контроль качества, исправление ошибок, корректировка направления.

---

## sdd.H4.11 Формат отчета о завершении этапа
После каждого этапа агент выводит:
```
---
ЭТАП [N] ЗАВЕРШЕН

Созданные артефакты:
- docs/requirements/<файл1>.md
- docs/requirements/<файл2>.md

Чеклист готовности:
- [x] Глоссарий заполнен (12 терминов)
- [x] Акторы определены (3 роли)
- [ ] Use Cases неполные -> GAP-001

Найденные пробелы: 1 (см. gap-tracking.md)

ОЖИДАЮ КОМАНДЫ для продолжения
---
```

---

## sdd.H4.12 Команды разработчика
| Команда | Действие агента |
|---------|-----------------|
| `Продолжай этап [N]` | Начать следующий этап |
| `Исправь: <описание>` | Внести правки в текущий артефакт |
| `Покажи статус` | Вывести текущее состояние всех этапов |
| `Добавь GAP: <описание>` | Добавить запись в gap-tracking.md |
| `Вернись к этапу [N]` | Переделать указанный этап |

---

## sdd.H3.6 Веди gap-tracking
Агент ведет файл `docs/requirements/gap-tracking.md` для фиксации пробелов.
**Почему важно:**
Без явной фиксации пробелы теряются, непонятно что блокирует работу, нет прозрачности рисков.

---

## sdd.H4.13 Формат gap-tracking
**Когда добавлять GAP:**
- Данные отсутствуют в источниках
- Требуется решение разработчика/заказчика
- Обнаружено противоречие в требованиях
- Зависимость от внешнего фактора
**Формат GAP:**
```markdown
| GAP-ID | Этап | Описание | Критичность | Блокирует | Статус |
|--------|------|----------|-------------|-----------|--------|
| GAP-001 | [1] | Не определены роли пользователей | HIGH | [3], [5] | OPEN |
```
**Критичность:**
- `HIGH` - блокирует несколько этапов, требует немедленного решения
- `MEDIUM` - блокирует 1 этап, решить до перехода
- `LOW` - не блокирует, можно отложить
**Важно:**
При разработке документации (SDD):
- Пробелы фиксируются ТОЛЬКО в `gap-tracking.md`
- Задачи в `.tasks/` НЕ создаются
Задачи `.tasks/` создаются позже - при разработке кода (см. [taskmanifest.md](taskmanifest.md)).

---

## sdd.H3.7 Работай с диаграммами правильно
Код диаграмм хранится в отдельных файлах, рендеринг в PNG/SVG, в markdown только ссылки.
**Почему важно:**
Inline-диаграммы в markdown не версионируются отдельно, сложно рендерить, невозможно переиспользовать.

---

## sdd.H4.14 Структура файлов диаграмм
**Правила:**
1. Код диаграммы → отдельный файл `*.plantuml` или `*.mmd`
2. Рендеринг → PNG/SVG в той же папке
3. В markdown → ссылка на изображение + комментарий с путем к исходнику
**Структура:**
```
docs/requirements/
  diagrams/
    domain-overview.plantuml
    domain-overview.png
  сценарии/<domain>/diagrams/
    UC-01-sequence.plantuml
    UC-01-sequence.png
```
**Вставка в документ:**
```markdown
<!-- Исходный код: diagrams/domain-overview.plantuml -->
![Обзор домена](diagrams/domain-overview.png)
```

---

## sdd.H4.15 Правила для агента (сводка)
**Агент ОБЯЗАН:**
1. Принять системные правила перед началом
2. Изучить `.source/` и самостоятельно строить артефакты
3. Сформулировать базовый контекст (название, определение, цель) и запросить подтверждение
4. Следовать `.requirements/трек разработки.md`
5. Выполнять один этап за раз
6. Полностью завершать этап перед переходом к следующему
7. Спрашивать разработчика только при выборе из вариантов или коллизии
8. Останавливаться после каждого этапа
9. Вести gap-tracking.md
10. Выносить диаграммы в отдельные файлы
11. Проверять чеклист готовности этапа
**Агент НЕ ДОЛЖЕН:**
1. Начинать документирование без анализа `.source/`
2. Выполнять несколько этапов за раз
3. Переходить к следующему этапу без команды
4. Оставлять "Не определено" в финальном артефакте
5. Спрашивать очевидные вещи или то, что выводится логически
6. Редактировать файлы в `.requirements/` (read-only)
7. Делать git commit/push
8. Оставлять inline-диаграммы в markdown
9. Создавать задачи в `.tasks/` (при SDD используется только gap-tracking.md)
