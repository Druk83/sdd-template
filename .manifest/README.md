# Инструкция по написанию манифестов

Манифест — набор правил поведения в конкретной области (Docker, TDD, зависимости и т.д.).
**Аудитория:** разработчики и агенты. Манифест читается обеими сторонами как единый источник правил.

---

## 1) Манифест — это правила, не документация
**Правильно:** заголовок раздела = правило/инструкция
```markdown
## 1) Не устанавливай вслепую
## 2) Используй конкретные команды аудита
## 3) Реагируй на CRITICAL/HIGH
```
**Неправильно:** заголовок раздела = категория/тема
```markdown
## 1) Принципы работы с зависимостями
## 2) Команды проверки
## 3) Уровни критичности
```

---

## 2) Пиши императивно
Обращайся напрямую:
- "Не устанавливай..."
- "Проверь перед..."
- "Сообщи о проблеме..."
- "Дождись подтверждения..."
Избегай пассивных конструкций:
- ~~"Должно быть проверено..."~~
- ~~"Рекомендуется использовать..."~~

---

## 3) Структура раздела

```markdown
## N) Название-правило
Краткое пояснение когда/зачем (1-2 предложения).
**Что делать:**
- Конкретное действие 1
- Конкретное действие 2
**Справочная информация:** (если нужна)
| Колонка | Значение |
|---------|----------|
| ... | ... |

**Запрещено:** (если есть)
- Антипаттерн 1
- Антипаттерн 2
```

---

## 4) Нумерация правил

Каждое правило внутри манифеста нумеруй по схеме:
```
<префикс>.H<уровень>.<номер>
```

**Формирование префикса:**
Убери суффикс `manifest` из имени файла.
- `dockermanifest.md` → префикс `docker`
- `pddmanifest.md` → префикс `pdd`
- `securitymanifest.md` → префикс `security`

**Уровни:**
- H3 - политики (общие принципы, императивы)
- H4 - стандарты (конкретные правила, форматы, команды)

**Пример структуры:**
```markdown
# Docker Manifest (H2)

Политики и стандарты работы с Docker.

---

## docker.H3.1 Не используй :latest в production
Политика версионирования образов: :latest непредсказуем.
**Почему важно:**
Образ с :latest может измениться без предупреждения.

---

## docker.H4.1 Фиксируй точную версию образа
`FROM node:18.20.1-alpine`, не `FROM node:18` или `FROM node:latest`

---

## docker.H3.2 Не храни секреты в образах
Секреты в слоях образа доступны при инспекции.
**Почему важно:**
Любой с доступом к образу получит секреты.

---

## docker.H4.2 Передавай секреты через механизмы runtime
- Docker secrets: `docker secret create`
- Environment файлы: `docker run --env-file`
- Volume с секретами (только read-only)
```

**Форматирование:**
- В заголовке файла укажи уровень: `# <Название> Manifest (H2)`
- Краткое описание манифеста после заголовка
- Разделитель `---` между правилами
- Внутри правил не используй лишние пустые строки
- После заголовка правила сразу идет текст, без пустой строки
**Трассируемость:**
Нумерация позволяет ссылаться на правила из других документов:
- Из кода: `// Следую docker.H4.2`
- Из документации: `Согласно docker.H3.1, запрещено использовать :latest`
- Связь с H1.X из конституции: `docker.H3.2 конкретизирует H1.2 (секреты)`

---

## 5) Разграничение политик (H3) и стандартов (H4)
**Политика (H3) — ЧТО и ПОЧЕМУ:**
- Принцип, императив верхнего уровня
- Отвечает на вопросы "Что делать?" и "Почему важно?"
- Может быть без конкретики реализации
- Стратегическое правило
**Стандарт (H4) — КАК именно:**
- Конкретное правило с примером/форматом/командой
- Отвечает на вопрос "Как именно это сделать?"
- Всегда содержит конкретику (код, команда, формат, шаблон)
- Тактическое правило
**ВАЖНО:** Политика и стандарт должны работать в паре:
- Политика без стандарта — слишком общая, непонятно как применять
- Стандарт без политики — непонятно зачем это нужно, нет контекста
**Правильная структура (политика + стандарт):**
```markdown
## docker.H3.1 Не используй :latest в production
Политика версионирования: образы с :latest непредсказуемы.
**Почему важно:**
Образ может измениться без предупреждения и сломать production.

---

## docker.H4.1 Фиксируй точную версию образа
`FROM node:18.20.1-alpine`, не `FROM node:18` или `FROM node:latest`
```

**Неправильно (стандарт без политики):**
```markdown
## docker.H4.1 Используй FROM node:18.20.1-alpine
Используй команду `FROM node:18.20.1-alpine` в Dockerfile.
```
**Проблема:** Непонятно ЗАЧЕМ фиксировать версию, нет контекста политики.
**Неправильно (политика без стандарта):**
```markdown
## docker.H3.1 Контролируй версии образов
Важно следить за версиями базовых образов для стабильности.
```
**Проблема:** Непонятно КАК именно контролировать, нет конкретики стандарта.
**Критерии определения уровня:**
| Вопрос | H3 (Политика) | H4 (Стандарт) |
|--------|---------------|---------------|
| Содержит код/команду? | Нет | Да |
| Содержит формат/шаблон? | Нет | Да |
| Объясняет "почему"? | Да | Опционально |
| Можно применить без доп. информации? | Нет | Да |
**Примеры пар политика-стандарт:**
| Область | H3 (Политика) | H4 (Стандарт) |
|---------|---------------|---------------|
| Docker | "Не храни секреты в образах" | "Передавай через `docker secret` или `--env-file`" |
| PDD | "Документируй незавершенный код" | "Формат: `@todo #TASK-ID:ESTIMATE Description`" |
| TDD | "Сначала тест, потом код" | "Naming: `test_<method>_<scenario>_<expected>`" |
| Dependencies | "Не устанавливай вслепую" | "Команда аудита: `npm audit --production`" |

---

## 6) Таблицы — только для справки
Таблицы используй для:
- Команд по языкам/инструментам
- Уровней/статусов с действиями
- Соответствий (файл → lock-файл)
Таблицы НЕ заменяют правила — они дополняют их.

---

## 7) Без глубоких обоснований
**Правильно:**
```markdown
## 3) Реагируй на CRITICAL/HIGH

| Уровень | Действие |
|---------|----------|
| CRITICAL | Предупредить немедленно |
```
**Неправильно:**
```markdown
## 3) Уровни критичности CVE
CVE (Common Vulnerabilities and Exposures) — это стандарт идентификации
уязвимостей. CVSS (Common Vulnerability Scoring System) определяет...
[3 абзаца теории]
```

Читателю не нужна теория — нужны действия.

---

## 8) Чеклист самопроверки манифеста
- [ ] Каждый заголовок раздела — это правило/инструкция?
- [ ] Используется императив?
- [ ] Все правила пронумерованы по схеме `<префикс>.H3.X` или `<префикс>.H4.X`?
- [ ] Политики (H3) и стандарты (H4) работают в паре?
- [ ] Каждая политика имеет хотя бы один стандарт?
- [ ] Каждый стандарт связан с политикой?
- [ ] Нет теоретических обоснований?
- [ ] Таблицы только для справки, не для правил?
- [ ] Понятно что делать в каждой ситуации?
- [ ] Есть раздел "Запрещено" где нужно?
- [ ] Применимо и для разработчика, и для агента?

---

## 9) Примеры хороших названий разделов
| Область | Хорошо | Плохо |
|---------|--------|-------|
| Зависимости | "Не устанавливай вслепую" | "Принципы установки" |
| Docker | "Не используй :latest" | "Версионирование образов" |
| TDD | "Сначала тест, потом код" | "Процесс TDD" |
| Git | "Не коммить секреты" | "Безопасность репозитория" |

---

## 10) Ограничение по объему
| Объем | Статус | Действие |
|-------|--------|----------|
| до 100 строк | Оптимально | — |
| 100-150 строк | Допустимо | — |
| 150-200 строк | Предупреждение | Проверить, можно ли сократить |
| 200+ строк | Превышение | Разделить на два манифеста |
**Если манифест превышает 200 строк:**
1. Сузить предметную область
2. Выделить подобласть в отдельный манифест
3. Убрать избыточные пояснения
**Примеры разделения:**
- `dockermanifest.md` → `dockerbuildmanifest.md` + `dockercomposemanifest.md`
- `securitymanifest.md` → `authmanifest.md` + `secretsmanifest.md`
**Именование:** `<область>manifest.md` — область слитно со словом manifest.

---

## 11) Автономность манифестов

Манифесты — **автономные** документы:
- НЕ зависят от `.requirements/`
- НЕ требуют контекста из других манифестов
- Читаются при работе с конкретной областью

Ссылки на внешние ресурсы допустимы только для справочников команд/инструментов.
