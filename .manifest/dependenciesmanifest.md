# Dependencies манифест (управление зависимостями)

Правила поведения агента при работе с зависимостями проекта.

---

## 1) Не устанавливай вслепую

Перед добавлением любой зависимости **обязательно проверь:**

- **Уязвимости (CVE)** — выполни аудит, см. команды в разделе 6
- **Актуальность** — последний релиз < 2 лет, не abandoned
- **Совместимость** — версия рантайма проекта поддерживается
- **Лицензия** — совместима с проектом
- **Стабильность** — stable/LTS, не alpha/beta/rc

**Если проверка не пройдена** — сообщи пользователю, не устанавливай.

---

## 2) Используй конкретные команды аудита

Не полагайся на "внутренние знания". Выполняй команды:

| Язык | Аудит уязвимостей | Проверка outdated |
|------|-------------------|-------------------|
| JavaScript | `npm audit` / `yarn audit` | `npm outdated` |
| Python | `pip-audit` / `safety check` | `pip list --outdated` |
| Go | `govulncheck ./...` | `go list -u -m all` |
| Rust | `cargo audit` | `cargo outdated` |
| Ruby | `bundle audit` | `bundle outdated` |
| PHP | `composer audit` | `composer outdated` |

**После установки** — всегда выполни аудит и сообщи результат.

---

## 3) Реагируй на CRITICAL/HIGH

Не игнорируй уязвимости. Действуй по уровню:

| Уровень | CVSS | Действие агента |
|---------|------|-----------------|
| CRITICAL | 9.0+ | **Предупредить немедленно**, предложить обновление или альтернативу |
| HIGH | 7.0-8.9 | **Предупредить**, предложить обновление |
| MEDIUM | 4.0-6.9 | Сообщить, предложить запланировать |
| LOW | < 4.0 | Сообщить, оставить на усмотрение |

**Если патч недоступен:**
- Сообщи об этом явно
- Предложи альтернативные пакеты
- Не продолжай установку без подтверждения пользователя

---

## 4) Фиксируй версии

После любой операции с зависимостями:

1. Обнови lock-файл
2. Убедись, что lock-файл будет в git
3. Сообщи пользователю об изменениях

**Lock-файлы по языкам:**

| Язык | Манифест | Lock-файл |
|------|----------|-----------|
| JavaScript/TS | package.json | package-lock.json / yarn.lock / pnpm-lock.yaml |
| Python | pyproject.toml / requirements.txt | poetry.lock / Pipfile.lock |
| Go | go.mod | go.sum |
| Rust | Cargo.toml | Cargo.lock |
| Ruby | Gemfile | Gemfile.lock |
| PHP | composer.json | composer.lock |

**Запрещено:**
- Использовать `*` или `latest`
- Устанавливать без lock-файла
- Прямые ссылки на git (кроме форков с обоснованием)

---

## 5) Не применяй force

При конфликте версий или peer dependencies:

1. **Сообщи о конфликте** — опиши, какие пакеты конфликтуют
2. **Предложи варианты** — обновить, даунгрейдить, найти альтернативу
3. **Дождись решения** — не продолжай без подтверждения

**Запрещено без явного запроса пользователя:**
- `--force`
- `--legacy-peer-deps`
- `npm install --force`
- `pip install --ignore-requires-python`

---

## 6) Диагностика перед действием

Перед установкой/обновлением ответь себе:

- [ ] Lock-файл существует и в git?
- [ ] Есть ли CRITICAL/HIGH CVE в текущих зависимостях?
- [ ] Peer dependencies удовлетворены?
- [ ] Версия рантайма проекта совместима?

**Если хотя бы один пункт — нет** — сначала реши проблему или сообщи пользователю.

---

## 7) Проверяй на archived/deprecated

Перед установкой и периодически для существующих зависимостей:

**Команды проверки:**

| Язык | Команда / способ |
|------|------------------|
| JavaScript | `npm view <pkg>` — смотри поле `deprecated` |
| JavaScript | `npm outdated` — deprecated помечаются |
| Python | `pip index versions <pkg>` — смотри warnings |
| Go | `go list -m -versions <module>` + проверь GitHub |
| Rust | `cargo search <crate>` — смотри описание |
| Любой | GitHub API: `gh repo view <owner/repo> --json isArchived` |

**Признаки archived/deprecated:**
- GitHub: плашка "This repository has been archived"
- npm: `npm WARN deprecated <pkg>@<version>: <message>`
- PyPI: статус "Inactive" или явное сообщение в описании
- Нет релизов > 2 лет + нет активности в issues

**Что делать если пакет archived:**
1. Сообщи пользователю
2. Найди активный форк или альтернативу
3. Оцени риск продолжения использования
4. Не устанавливай без явного подтверждения

**Периодическая проверка существующих зависимостей:**
```bash
# JavaScript — покажет deprecated
npm outdated

# Проверить конкретный пакет
npm view <package-name> deprecated
```

---

## 8) Правила обновления

| Тип обновления | Действие агента |
|----------------|-----------------|
| Patch (0.0.x) | Применять, проверить аудит |
| Minor (0.x.0) | Проверить CHANGELOG, затем применять |
| Major (x.0.0) | Сообщить о breaking changes, дождаться подтверждения |

**При обновлении:**
- Прочитай CHANGELOG (для minor/major)
- Проверь breaking changes (для major)
- Выполни тесты после обновления
- Выполни аудит
